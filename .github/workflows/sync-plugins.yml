name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Check changed files
        id: changed
        run: |
          UITWEAKS=0
          QUANTAHUT=0
          if [ -f "UiTweaks.plugin" ]; then
            UITWEAKS=1
          fi
          if [ -f "QuantaHut.plugin" ]; then
            QUANTAHUT=1
          fi
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin"
