name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check changed files
        id: changed
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD)
          echo "Changed files:"
          echo "$CHANGED_FILES"
          
          if echo "$CHANGED_FILES" | grep -q "^UiTweaks.plugin$"; then
            echo "uitweaks=true" >> $GITHUB_OUTPUT
            echo "UiTweaks changed: true"
          else
            echo "uitweaks=false" >> $GITHUB_OUTPUT
            echo "UiTweaks changed: false"
          fi
          
          if echo "$CHANGED_FILES" | grep -q "^QuantaHut.plugin$"; then
            echo "quantahut=true" >> $GITHUB_OUTPUT
            echo "QuantaHut changed: true"
          else
            echo "quantahut=false" >> $GITHUB_OUTPUT
            echo "QuantaHut changed: false"
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks == 'false' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin"
