name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: changed
        run: |
          UITWEAKS=$(git diff --name-only HEAD~1 HEAD | grep -c "^UiTweaks.plugin$" || true)
          QUANTAHUT=$(git diff --name-only HEAD~1 HEAD | grep -c "^QuantaHut.plugin$" || true)
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT
          echo "UiTweaks changed: $UITWEAKS, QuantaHut changed: $QUANTAHUT"

      - name: Get commit messages
        id: commits
        run: |
          BRANCH="${{ github.ref_name }}"
          
          # Function to escape MarkdownV2 special characters
          escape_markdown() {
            echo "$1" | sed 's/\([_*\[\]()~`>#+=|{}.!-]\)/\\\1/g'
          }
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^UiTweaks.plugin$"; then
            COMMIT_COUNT=$(git log ${{ github.event.before }}..${{ github.event.after }} --oneline -- UiTweaks.plugin | wc -l)
            UITWEAKS_HEADER="${COMMIT_COUNT} new commit(s) to ${{ github.repository }}:${BRANCH}:"
            
            UITWEAKS_COMMITS=""
            while IFS= read -r line; do
              HASH=$(echo "$line" | awk '{print $1}')
              SUBJECT=$(echo "$line" | cut -d' ' -f2-)
              AUTHOR=$(echo "$line" | awk -F'|' '{print $2}')
              URL="https://github.com/${{ github.repository }}/commit/${HASH}"
              
              ESCAPED_SUBJECT=$(escape_markdown "$SUBJECT")
              ESCAPED_AUTHOR=$(escape_markdown "$AUTHOR")
              
              UITWEAKS_COMMITS="${UITWEAKS_COMMITS}[${HASH}](${URL}): ${ESCAPED_SUBJECT} by ${ESCAPED_AUTHOR}"$'\n'
            done < <(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"%h %s|%an" -- UiTweaks.plugin)
            
            echo "uitweaks_header<<EOF" >> $GITHUB_OUTPUT
            echo "$UITWEAKS_HEADER" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "uitweaks<<EOF" >> $GITHUB_OUTPUT
            echo "$UITWEAKS_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^QuantaHut.plugin$"; then
            COMMIT_COUNT=$(git log ${{ github.event.before }}..${{ github.event.after }} --oneline -- QuantaHut.plugin | wc -l)
            QUANTAHUT_HEADER="${COMMIT_COUNT} new commit(s) to ${{ github.repository }}:${BRANCH}:"
            
            QUANTAHUT_COMMITS=""
            while IFS= read -r line; do
              HASH=$(echo "$line" | awk '{print $1}')
              SUBJECT=$(echo "$line" | cut -d' ' -f2-)
              AUTHOR=$(echo "$line" | awk -F'|' '{print $2}')
              URL="https://github.com/${{ github.repository }}/commit/${HASH}"
              
              ESCAPED_SUBJECT=$(escape_markdown "$SUBJECT")
              ESCAPED_AUTHOR=$(escape_markdown "$AUTHOR")
              
              QUANTAHUT_COMMITS="${QUANTAHUT_COMMITS}[${HASH}](${URL}): ${ESCAPED_SUBJECT} by ${ESCAPED_AUTHOR}"$'\n'
            done < <(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"%h %s|%an" -- QuantaHut.plugin)
            
            echo "quantahut_header<<EOF" >> $GITHUB_OUTPUT
            echo "$QUANTAHUT_HEADER" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
            echo "quantahut<<EOF" >> $GITHUB_OUTPUT
            echo "$QUANTAHUT_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_HEADER: ${{ steps.commits.outputs.uitweaks_header }}
          UITWEAKS_COMMITS: ${{ steps.commits.outputs.uitweaks }}
          QUANTAHUT_HEADER: ${{ steps.commits.outputs.quantahut_header }}
          QUANTAHUT_COMMITS: ${{ steps.commits.outputs.quantahut }}
        run: |
          # Escape MarkdownV2 special characters
          escape_markdown() {
            local text="$1"
            text="${text//\\/\\\\}"
            text="${text//_/\\_}"
            text="${text//*/\\*}"
            text="${text//[/\\[}"
            text="${text//]/\\]}"
            text="${text//(/\\(}"
            text="${text//)/\\)}"
            text="${text//~/\\~}"
            text="${text//\`/\\\`}"
            text="${text//>/\\>}"
            text="${text//#/\\#}"
            text="${text//+/\\+}"
            text="${text//=/\\=}"
            text="${text//|/\\|}"
            text="${text//\{/\\\{}"
            text="${text//\}/\\\}}"
            text="${text//./\\.}"
            text="${text//!/\\!}"
            text="${text//-/\\-}"
            echo "$text"
          }
          
          ESCAPED_UITWEAKS_HEADER=$(escape_markdown "$UITWEAKS_HEADER")
          ESCAPED_QUANTAHUT_HEADER=$(escape_markdown "$QUANTAHUT_HEADER")
          
          FULL_CAPTION="*UiTweaks:*
          ${ESCAPED_UITWEAKS_HEADER}
          ${UITWEAKS_COMMITS}
          *QuantaHut:*
          ${ESCAPED_QUANTAHUT_HEADER}
          ${QUANTAHUT_COMMITS}"
          
          if [ "${#FULL_CAPTION}" -gt 1024 ]; then
            CAPTION="${FULL_CAPTION:0:1020}..."
            EXTRA="${FULL_CAPTION:1020}"
          else
            CAPTION="${FULL_CAPTION}"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\",\"caption\":\"${CAPTION}\",\"parse_mode\":\"MarkdownV2\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -F "chat_id=${CHAT_ID}" \
              -F "text=\\.\\.\\.continued:
          ${EXTRA}" \
              -F "parse_mode=MarkdownV2"
          fi

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_HEADER: ${{ steps.commits.outputs.uitweaks_header }}
          UITWEAKS_COMMITS: ${{ steps.commits.outputs.uitweaks }}
        run: |
          # Escape MarkdownV2 special characters
          escape_markdown() {
            local text="$1"
            text="${text//\\/\\\\}"
            text="${text//_/\\_}"
            text="${text//*/\\*}"
            text="${text//[/\\[}"
            text="${text//]/\\]}"
            text="${text//(/\\(}"
            text="${text//)/\\)}"
            text="${text//~/\\~}"
            text="${text//\`/\\\`}"
            text="${text//>/\\>}"
            text="${text//#/\\#}"
            text="${text//+/\\+}"
            text="${text//=/\\=}"
            text="${text//|/\\|}"
            text="${text//\{/\\\{}"
            text="${text//\}/\\\}}"
            text="${text//./\\.}"
            text="${text//!/\\!}"
            text="${text//-/\\-}"
            echo "$text"
          }
          
          ESCAPED_HEADER=$(escape_markdown "$UITWEAKS_HEADER")
          
          FULL_CAPTION="*${ESCAPED_HEADER}*
          ${UITWEAKS_COMMITS}"
          
          if [ "${#FULL_CAPTION}" -gt 1024 ]; then
            CAPTION="${FULL_CAPTION:0:1020}..."
            EXTRA="${FULL_CAPTION:1020}"
          else
            CAPTION="${FULL_CAPTION}"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin" \
            -F "caption=${CAPTION}" \
            -F "parse_mode=MarkdownV2"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -F "chat_id=${CHAT_ID}" \
              -F "text=\\.\\.\\.continued:
          ${EXTRA}" \
              -F "parse_mode=MarkdownV2"
          fi

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          QUANTAHUT_HEADER: ${{ steps.commits.outputs.quantahut_header }}
          QUANTAHUT_COMMITS: ${{ steps.commits.outputs.quantahut }}
        run: |
          # Escape MarkdownV2 special characters
          escape_markdown() {
            local text="$1"
            text="${text//\\/\\\\}"
            text="${text//_/\\_}"
            text="${text//*/\\*}"
            text="${text//[/\\[}"
            text="${text//]/\\]}"
            text="${text//(/\\(}"
            text="${text//)/\\)}"
            text="${text//~/\\~}"
            text="${text//\`/\\\`}"
            text="${text//>/\\>}"
            text="${text//#/\\#}"
            text="${text//+/\\+}"
            text="${text//=/\\=}"
            text="${text//|/\\|}"
            text="${text//\{/\\\{}"
            text="${text//\}/\\\}}"
            text="${text//./\\.}"
            text="${text//!/\\!}"
            text="${text//-/\\-}"
            echo "$text"
          }
          
          ESCAPED_HEADER=$(escape_markdown "$QUANTAHUT_HEADER")
          
          FULL_CAPTION="*${ESCAPED_HEADER}*
          ${QUANTAHUT_COMMITS}"
          
          if [ "${#FULL_CAPTION}" -gt 1024 ]; then
            CAPTION="${FULL_CAPTION:0:1020}..."
            EXTRA="${FULL_CAPTION:1020}"
          else
            CAPTION="${FULL_CAPTION}"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin" \
            -F "caption=${CAPTION}" \
            -F "parse_mode=MarkdownV2"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -F "chat_id=${CHAT_ID}" \
              -F "text=\\.\\.\\.continued:
          ${EXTRA}" \
              -F "parse_mode=MarkdownV2"
          fi
