name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files and get commits
        id: changed
        run: |
          UITWEAKS=$(git diff --name-only HEAD~1 HEAD | grep -c "^UiTweaks.plugin$" || true)
          QUANTAHUT=$(git diff --name-only HEAD~1 HEAD | grep -c "^QuantaHut.plugin$" || true)
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT
          echo "UiTweaks changed: $UITWEAKS, QuantaHut changed: $QUANTAHUT"
          
          if [ "$UITWEAKS" = "1" ]; then
            COMMITS=$(git log --pretty=format:"â€¢ %s" --follow -- UiTweaks.plugin)
            echo "uitweaks_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          if [ "$QUANTAHUT" = "1" ]; then
            COMMITS=$(git log --pretty=format:"â€¢ %s" --follow -- QuantaHut.plugin)
            echo "quantahut_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import json
          import requests
          
          bot_token = os.environ['BOT_TOKEN']
          chat_id = os.environ['CHAT_ID']
          uitweaks_commits = os.environ.get('UITWEAKS_COMMITS', '')
          quantahut_commits = os.environ.get('QUANTAHUT_COMMITS', '')
          
          caption = f"ðŸ“¦ UiTweaks Updates:\n{uitweaks_commits}\n\nðŸ“¦ QuantaHut Updates:\n{quantahut_commits}"
          
          files = {
              'file1': open('UiTweaks.plugin', 'rb'),
              'file2': open('QuantaHut.plugin', 'rb')
          }
          
          data = {
              'chat_id': chat_id,
              'media': json.dumps([
                  {'type': 'document', 'media': 'attach://file1'},
                  {'type': 'document', 'media': 'attach://file2', 'caption': caption}
              ])
          }
          
          response = requests.post(f'https://api.telegram.org/bot{bot_token}/sendMediaGroup', data=data, files=files)
          print(response.text)
          PYTHON_EOF
        env:
          UITWEAKS_COMMITS: ${{ steps.changed.outputs.uitweaks_commits }}
          QUANTAHUT_COMMITS: ${{ steps.changed.outputs.quantahut_commits }}

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import requests
          
          bot_token = os.environ['BOT_TOKEN']
          chat_id = os.environ['CHAT_ID']
          uitweaks_commits = os.environ.get('UITWEAKS_COMMITS', '')
          
          caption = f"ðŸ“¦ UiTweaks Updates:\n{uitweaks_commits}"
          
          files = {'document': open('UiTweaks.plugin', 'rb')}
          data = {'chat_id': chat_id, 'caption': caption}
          
          response = requests.post(f'https://api.telegram.org/bot{bot_token}/sendDocument', data=data, files=files)
          print(response.text)
          PYTHON_EOF
        env:
          UITWEAKS_COMMITS: ${{ steps.changed.outputs.uitweaks_commits }}

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          python3 << 'PYTHON_EOF'
          import os
          import requests
          
          bot_token = os.environ['BOT_TOKEN']
          chat_id = os.environ['CHAT_ID']
          quantahut_commits = os.environ.get('QUANTAHUT_COMMITS', '')
          
          caption = f"ðŸ“¦ QuantaHut Updates:\n{quantahut_commits}"
          
          files = {'document': open('QuantaHut.plugin', 'rb')}
          data = {'chat_id': chat_id, 'caption': caption}
          
          response = requests.post(f'https://api.telegram.org/bot{bot_token}/sendDocument', data=data, files=files)
          print(response.text)
          PYTHON_EOF
        env:
          QUANTAHUT_COMMITS: ${{ steps.changed.outputs.quantahut_commits }}
