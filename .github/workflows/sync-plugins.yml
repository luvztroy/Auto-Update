name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: changed
        run: |
          UITWEAKS=$(git diff --name-only HEAD~1 HEAD | grep -c "^UiTweaks.plugin$" || true)
          QUANTAHUT=$(git diff --name-only HEAD~1 HEAD | grep -c "^QuantaHut.plugin$" || true)
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT
          echo "UiTweaks changed: $UITWEAKS, QuantaHut changed: $QUANTAHUT"

      - name: Get commit messages
        id: commits
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^UiTweaks.plugin$"; then
            UITWEAKS_COMMITS=$(git log --pretty=format:"• %s" --follow -- UiTweaks.plugin | tr '\n' '\n')
            echo "uitweaks<<EOF" >> $GITHUB_OUTPUT
            echo "$UITWEAKS_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^QuantaHut.plugin$"; then
            QUANTAHUT_COMMITS=$(git log --pretty=format:"• %s" --follow -- QuantaHut.plugin | tr '\n' '\n')
            echo "quantahut<<EOF" >> $GITHUB_OUTPUT
            echo "$QUANTAHUT_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_COMMITS: ${{ steps.commits.outputs.uitweaks }}
          QUANTAHUT_COMMITS: ${{ steps.commits.outputs.quantahut }}
        run: |
          CAPTION="UiTweaks:\n${UITWEAKS_COMMITS}\n\nQuantaHut:\n${QUANTAHUT_COMMITS}"
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\",\"caption\":\"${CAPTION}\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin" \
            -F "caption=${COMMIT_MSG}"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          COMMIT_MSG: ${{ github.event.head_commit.message }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin" \
            -F "caption=${COMMIT_MSG}"
