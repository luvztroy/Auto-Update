name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Check version changes
        id: changed
        run: |
          # Function to extract version from file content
          get_version() {
            grep -oP "__version__\s*=\s*[\"']\K[^\"']+" <<< "$1" || echo ""
          }
          
          # UiTweaks version comparison
          if [ -f "UiTweaks.plugin" ]; then
            CURRENT_UI=$(get_version "$(cat UiTweaks.plugin)")
            OLD_UI=$(get_version "$(git show HEAD~1:UiTweaks.plugin 2>/dev/null)" || echo "")
            
            echo "UiTweaks: $OLD_UI -> $CURRENT_UI"
            
            if [ -n "$CURRENT_UI" ] && [ "$CURRENT_UI" != "$OLD_UI" ]; then
              echo "uitweaks=true" >> $GITHUB_OUTPUT
              echo "uitweaks_ver=$CURRENT_UI" >> $GITHUB_OUTPUT
            else
              echo "uitweaks=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "uitweaks=false" >> $GITHUB_OUTPUT
          fi
          
          # QuantaHut version comparison
          if [ -f "QuantaHut.plugin" ]; then
            CURRENT_QH=$(get_version "$(cat QuantaHut.plugin)")
            OLD_QH=$(get_version "$(git show HEAD~1:QuantaHut.plugin 2>/dev/null)" || echo "")
            
            echo "QuantaHut: $OLD_QH -> $CURRENT_QH"
            
            if [ -n "$CURRENT_QH" ] && [ "$CURRENT_QH" != "$OLD_QH" ]; then
              echo "quantahut=true" >> $GITHUB_OUTPUT
              echo "quantahut_ver=$CURRENT_QH" >> $GITHUB_OUTPUT
            else
              echo "quantahut=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "quantahut=false" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks == 'false' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin"
