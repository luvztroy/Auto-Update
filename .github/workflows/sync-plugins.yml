name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 2

      - name: Get commit message
        id: commit
        run: echo "message=$(git log -1 --pretty=%B | tr '\n' ' ')" >> $GITHUB_OUTPUT

      - name: Check changed files
        id: changes
        run: |
          UITWEAKS_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c "UiTweaks.plugin" || echo "0")
          QUANTAHUT_CHANGED=$(git diff --name-only HEAD~1 HEAD | grep -c "QuantaHut.plugin" || echo "0")
          echo "uitweaks=$UITWEAKS_CHANGED" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT_CHANGED" >> $GITHUB_OUTPUT

      - name: Upload both as group
        if: steps.changes.outputs.uitweaks != '0' && steps.changes.outputs.quantahut != '0'
        run: |
          curl -F "chat_id=${{ secrets.TELEGRAM_GROUP_ID }}" \
               -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\",\"caption\":\"${{ steps.commit.outputs.message }}\"}]" \
               -F "file1=@UiTweaks.plugin" \
               -F "file2=@QuantaHut.plugin" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendMediaGroup

      - name: Upload UiTweaks only
        if: steps.changes.outputs.uitweaks != '0' && steps.changes.outputs.quantahut == '0'
        run: |
          curl -F "chat_id=${{ secrets.TELEGRAM_GROUP_ID }}" \
               -F "document=@UiTweaks.plugin" \
               -F "caption=${{ steps.commit.outputs.message }}" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument

      - name: Upload QuantaHut only
        if: steps.changes.outputs.uitweaks == '0' && steps.changes.outputs.quantahut != '0'
        run: |
          curl -F "chat_id=${{ secrets.TELEGRAM_GROUP_ID }}" \
               -F "document=@QuantaHut.plugin" \
               -F "caption=${{ steps.commit.outputs.message }}" \
               https://api.telegram.org/bot${{ secrets.TELEGRAM_BOT_TOKEN }}/sendDocument
