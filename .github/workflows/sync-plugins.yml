name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files and get commits
        id: changed
        run: |
          UITWEAKS=$(git diff --name-only HEAD~1 HEAD | grep -c "^UiTweaks.plugin$" || true)
          QUANTAHUT=$(git diff --name-only HEAD~1 HEAD | grep -c "^QuantaHut.plugin$" || true)
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT
          echo "UiTweaks changed: $UITWEAKS, QuantaHut changed: $QUANTAHUT"
          
          if [ "$UITWEAKS" = "1" ]; then
            COMMITS=$(git log --pretty=format:"• %s" --follow -- UiTweaks.plugin)
            echo "uitweaks_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          if [ "$QUANTAHUT" = "1" ]; then
            COMMITS=$(git log --pretty=format:"• %s" --follow -- QuantaHut.plugin)
            echo "quantahut_commits<<EOF" >> $GITHUB_OUTPUT
            echo "$COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_COMMITS: ${{ steps.changed.outputs.uitweaks_commits }}
          QUANTAHUT_COMMITS: ${{ steps.changed.outputs.quantahut_commits }}
        run: |
          cat > caption.txt << 'CAPTION_EOF'
          <tg-emoji emoji-id="6030563507299160824">❗️</tg-emoji> UiTweaks Updates:
          ${UITWEAKS_COMMITS}

          <tg-emoji emoji-id="6030563507299160824">❗️</tg-emoji> QuantaHut Updates:
          ${QUANTAHUT_COMMITS}
          CAPTION_EOF
          
          CAPTION=$(envsubst < caption.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\",\"caption\":\"$(echo "$CAPTION" | sed 's/"/\\"/g')\",\"parse_mode\":\"HTML\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_COMMITS: ${{ steps.changed.outputs.uitweaks_commits }}
        run: |
          cat > caption.txt << 'CAPTION_EOF'
          <tg-emoji emoji-id="6030563507299160824">❗️</tg-emoji> UiTweaks Updates:
          ${UITWEAKS_COMMITS}
          CAPTION_EOF
          
          CAPTION=$(envsubst < caption.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin" \
            -F "caption=$(echo "$CAPTION" | sed 's/"/\\"/g')" \
            -F "parse_mode=HTML"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          QUANTAHUT_COMMITS: ${{ steps.changed.outputs.quantahut_commits }}
        run: |
          cat > caption.txt << 'CAPTION_EOF'
          <tg-emoji emoji-id="6030563507299160824">❗️</tg-emoji> QuantaHut Updates:
          ${QUANTAHUT_COMMITS}
          CAPTION_EOF
          
          CAPTION=$(envsubst < caption.txt)
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin" \
            -F "caption=$(echo "$CAPTION" | sed 's/"/\\"/g')" \
            -F "parse_mode=HTML"
