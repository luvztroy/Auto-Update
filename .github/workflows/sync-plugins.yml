name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Check version changes
        id: changed
        run: |
          get_version() {
            grep -oP "__version__\s*=\s*[\"']\K[^\"']+" <<< "$1" || echo ""
          }
          
          # Load last uploaded versions (or empty if not exists)
          if [ -f "Version History.json" ]; then
            LAST_UI=$(jq -r '.uitweaks // ""' "Version History.json")
            LAST_QH=$(jq -r '.quantahut // ""' "Version History.json")
          else
            LAST_UI=""
            LAST_QH=""
          fi
          
          # Get current versions
          CURRENT_UI=""
          CURRENT_QH=""
          
          if [ -f "UiTweaks.plugin" ]; then
            CURRENT_UI=$(get_version "$(cat UiTweaks.plugin)")
          fi
          
          if [ -f "QuantaHut.plugin" ]; then
            CURRENT_QH=$(get_version "$(cat QuantaHut.plugin)")
          fi
          
          echo "UiTweaks: $LAST_UI -> $CURRENT_UI"
          echo "QuantaHut: $LAST_QH -> $CURRENT_QH"
          
          # Compare and set outputs
          if [ -n "$CURRENT_UI" ] && [ "$CURRENT_UI" != "$LAST_UI" ]; then
            echo "uitweaks=true" >> $GITHUB_OUTPUT
            echo "uitweaks_ver=$CURRENT_UI" >> $GITHUB_OUTPUT
          else
            echo "uitweaks=false" >> $GITHUB_OUTPUT
          fi
          
          if [ -n "$CURRENT_QH" ] && [ "$CURRENT_QH" != "$LAST_QH" ]; then
            echo "quantahut=true" >> $GITHUB_OUTPUT
            echo "quantahut_ver=$CURRENT_QH" >> $GITHUB_OUTPUT
          else
            echo "quantahut=false" >> $GITHUB_OUTPUT
          fi
          
          # Store current versions for commit
          echo "current_ui=$CURRENT_UI" >> $GITHUB_OUTPUT
          echo "current_qh=$CURRENT_QH" >> $GITHUB_OUTPUT

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == 'true' && steps.changed.outputs.quantahut == 'false'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin"

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks == 'false' && steps.changed.outputs.quantahut == 'true'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
        run: |
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin"

      - name: Update version tracking
        if: steps.changed.outputs.uitweaks == 'true' || steps.changed.outputs.quantahut == 'true'
        run: |
          echo '{"uitweaks":"${{ steps.changed.outputs.current_ui }}","quantahut":"${{ steps.changed.outputs.current_qh }}"}' > Version History.json
          
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add "Version History.json"
          git commit -m "chore: update version tracking [skip ci]"
          git push
