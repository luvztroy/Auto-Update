name: Sync Plugins to Telegram

on:
  push:
    branches: [main, Beta]
    paths:
      - 'UiTweaks.plugin'
      - 'QuantaHut.plugin'

jobs:
  sync:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Check changed files
        id: changed
        run: |
          UITWEAKS=$(git diff --name-only HEAD~1 HEAD | grep -c "^UiTweaks.plugin$" || true)
          QUANTAHUT=$(git diff --name-only HEAD~1 HEAD | grep -c "^QuantaHut.plugin$" || true)
          echo "uitweaks=$UITWEAKS" >> $GITHUB_OUTPUT
          echo "quantahut=$QUANTAHUT" >> $GITHUB_OUTPUT
          echo "UiTweaks changed: $UITWEAKS, QuantaHut changed: $QUANTAHUT"

      - name: Get commit messages
        id: commits
        run: |
          if git diff --name-only HEAD~1 HEAD | grep -q "^UiTweaks.plugin$"; then
            UITWEAKS_COMMITS=$(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"• %s" -- UiTweaks.plugin)
            echo "uitweaks<<EOF" >> $GITHUB_OUTPUT
            echo "$UITWEAKS_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi
          
          if git diff --name-only HEAD~1 HEAD | grep -q "^QuantaHut.plugin$"; then
            QUANTAHUT_COMMITS=$(git log ${{ github.event.before }}..${{ github.event.after }} --pretty=format:"• %s" -- QuantaHut.plugin)
            echo "quantahut<<EOF" >> $GITHUB_OUTPUT
            echo "$QUANTAHUT_COMMITS" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

      - name: Upload both (grouped)
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_COMMITS: ${{ steps.commits.outputs.uitweaks }}
          QUANTAHUT_COMMITS: ${{ steps.commits.outputs.quantahut }}
        run: |
          FULL_CAPTION="UiTweaks:\n${UITWEAKS_COMMITS}\n\nQuantaHut:\n${QUANTAHUT_COMMITS}"
          
          if [ ${#FULL_CAPTION} -gt 1024 ]; then
            CAPTION="${FULL_CAPTION:0:1000}..."
            EXTRA="${FULL_CAPTION:1000}"
          else
            CAPTION="$FULL_CAPTION"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMediaGroup" \
            -F "chat_id=${CHAT_ID}" \
            -F "media=[{\"type\":\"document\",\"media\":\"attach://file1\"},{\"type\":\"document\",\"media\":\"attach://file2\",\"caption\":\"${CAPTION}\"}]" \
            -F "file1=@UiTweaks.plugin" \
            -F "file2=@QuantaHut.plugin"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "text=...continued:\n${EXTRA}"
          fi

      - name: Upload UiTweaks only
        if: steps.changed.outputs.uitweaks == '1' && steps.changed.outputs.quantahut != '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          UITWEAKS_COMMITS: ${{ steps.commits.outputs.uitweaks }}
        run: |
          if [ ${#UITWEAKS_COMMITS} -gt 1024 ]; then
            CAPTION="${UITWEAKS_COMMITS:0:1000}..."
            EXTRA="${UITWEAKS_COMMITS:1000}"
          else
            CAPTION="$UITWEAKS_COMMITS"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@UiTweaks.plugin" \
            -F "caption=${CAPTION}"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "text=...continued:\n${EXTRA}"
          fi

      - name: Upload QuantaHut only
        if: steps.changed.outputs.uitweaks != '1' && steps.changed.outputs.quantahut == '1'
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          CHAT_ID: ${{ secrets.TELEGRAM_GROUP_ID }}
          QUANTAHUT_COMMITS: ${{ steps.commits.outputs.quantahut }}
        run: |
          if [ ${#QUANTAHUT_COMMITS} -gt 1024 ]; then
            CAPTION="${QUANTAHUT_COMMITS:0:1000}..."
            EXTRA="${QUANTAHUT_COMMITS:1000}"
          else
            CAPTION="$QUANTAHUT_COMMITS"
            EXTRA=""
          fi
          
          curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendDocument" \
            -F "chat_id=${CHAT_ID}" \
            -F "document=@QuantaHut.plugin" \
            -F "caption=${CAPTION}"
          
          if [ -n "$EXTRA" ]; then
            curl -s -X POST "https://api.telegram.org/bot${BOT_TOKEN}/sendMessage" \
              -d "chat_id=${CHAT_ID}" \
              -d "text=...continued:\n${EXTRA}"
          fi
