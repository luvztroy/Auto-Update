
# Library for Quanta Plugins
# Also a big thanks to @zwyPlugins, We took some code snippets from zwylib


import json
import time
import copy
import threading
import traceback
import os.path
import tempfile
import urllib.request
from typing import List, Callable, Optional, Any
from dataclasses import dataclass

from base_plugin import BasePlugin, HookStrategy, MenuItemData, MenuItemType
from android_utils import log, run_on_ui_thread
from client_utils import get_last_fragment, run_on_queue
from ui.bulletin import BulletinHelper
from ui.settings import Divider, Header, Switch, Input, Text, Selector

from org.telegram.messenger import Utilities, AndroidUtilities, MediaDataController, ImageLocation
from com.exteragram.messenger.utils import ChatUtils
from java import dynamic_proxy, cast, jclass
from java.util import ArrayList
from java.lang import Integer
from org.telegram.messenger import MessageObject, R as R_tg
from org.telegram.ui import ChatActivity
from org.telegram.ui.ActionBar import BottomSheet, Theme, SimpleTextView
from android.view import HapticFeedbackConstants
from org.telegram.ui.Components import BackupImageView, LayoutHelper
from android.view import Gravity
from android.widget import LinearLayout, TextView, FrameLayout
from android.util import TypedValue
from hook_utils import find_class, get_private_field, set_private_field
from java.io import File

__name__ = "QuantaHut"
__description__ = "Library for Quanta plugins"
__icon__ = "luvztroyIcons/14"
__id__ = "quantahut"
__version__ = "1.5.0"
__author__ = "@luvztroy"
__min_version__ = "12.1.1"
__priority__ = 1

DEFAULT_SHOW_LOGS = False
DEFAULT_SHOW_RESTART_MENU = False
DEFAULT_BRANCH = 0
RunnableClass = jclass("java.lang.Runnable")
RunnableProxy = dynamic_proxy(RunnableClass)
MAX_HISTORY = 5  
setting_getter = None


class QuantaHut(BasePlugin):
    def __init__(self):
        super().__init__()
        self.hook_refs = []
        self.available_languages = []
        self.current_language = "en"
        self.localization_cache = github_localization.localization_cache
        self.restart_menu_item = None
        self.current_filter = 0
        self.filter_pills = []
        self.pills_container = None
        self.stored_context = None
        self.stored_activity = None

        self._search_state = {}
        self._all_items_cache = {}
        self._search_history = {}
        self._activity_refs = {}
        self.settings_search_create_view_hook = None
        self.settings_search_fill_items_hook = None

    
    def log(self, message: str):
        if self.get_setting("show_logs", DEFAULT_SHOW_LOGS):
            log(f"[QuantaHut] {message}")
    
    def create_settings(self):
        show_branch_selector = self.get_setting("show_branch_selector", False)
        
        settings = [
            Header(text=get_string("quantahut_configuration", "QuantaHut Configuration")),
            Switch(key="show_logs", text=get_string("enable_debug_logging_quantahut", "Enable Debug Logging"), default=DEFAULT_SHOW_LOGS, icon="menu_intro_solar"),
            Switch(key="show_restart_menu", text=get_string("quantahut_show_restart", "Show Restart in Drawer"), default=DEFAULT_SHOW_RESTART_MENU, icon="msg_retry", on_change=self._on_restart_toggle_changed),
            Header(text=get_string("updates", "Updates")),

            Text(text=get_string("check_update", "Check for Plugin Updates"), accent=True, icon="msg_download_solar", on_click=lambda v: check_quanta_updates()),
        ]
        
        if show_branch_selector:
            settings.extend([
                Selector(key="update_branch", text=get_string("update_branch", "Update Branch"), items=[get_string("branch_main", "Main"), get_string("branch_beta", "Beta")], default=DEFAULT_BRANCH, icon="msg_folders"),
                Divider(text=get_string("update_branch_info", "Select which branch to receive updates and download localization files from. Beta may contain experimental features and newer translations.")),
            ])

            
        
        settings.extend([
            Header(text=get_string("pluging_engine", "Plugin engine features")),
            Text(text=get_string("export_all_settings", "Export All Plugin Settings"), icon="msg_photo_rotate_solar", on_click=self._export_all_settings),
            Text(text=get_string("export_all_plugins", "Export All Plugins"), icon="msg_photo_rotate_solar", on_click=self._export_all_plugins),
    
            Header(text=get_string("cleanup", "Cleanup & Reset")),
            Text(text=get_string("clear_file_cache", "Clear File Cache"), red=True, on_click=self._clear_file_cache, icon="msg_delete"),
            Text(text=get_string("reset_language_preference", "Reset Language Preference"), red=True, on_click=self._reset_language_preference, on_long_click=self._toggle_branch_selector, icon="msg_delete"),
            Divider(text=self._get_cache_info_text()),
        ])
        
        return settings

    def on_plugin_load(self):
        self.log("Initializing QuantaHut...")
        global setting_getter
        setting_getter = self.get_setting
        QuantaHut.instance = self

        self.custom_badges = {}
        self.badge_hook_ref = None
        self.developer_hook_ref = None
        self.extera_hook_ref = None
        self.TLRPC_User = None
        self.TLRPC_Chat = None
        
        self.update_available = False
        self.latest_version = None
        self.changelog = None
        self.download_url = None
        self.checking_update = False
        
        self.setup_hooks()
        self._update_restart_menu_item()
        self._setup_quanta_file_hook()
        
        self._setup_deeplink_handling()
        self._setup_enhanced_plugin_search()
        self._setup_plugin_settings_search()
        
        self._load_available_languages()
        
        self.log("QuantaHut initialized with GitHub-based system")
        
        self._check_for_updates_on_load()


    def _setup_deeplink_handling(self):
        try:
            LaunchActivity = find_class("org.telegram.ui.LaunchActivity")
            if LaunchActivity:
                method = LaunchActivity.getClass().getDeclaredMethod("handleIntent", 
                    find_class("android.content.Intent").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE,
                    find_class("org.telegram.messenger.browser.Browser$Progress").getClass(),
                    find_class("java.lang.Boolean").TYPE,
                    find_class("java.lang.Boolean").TYPE)
                method.setAccessible(True)
                self.hook_refs.append(self.hook_method(method, QuantaDeeplinkHook(self)))
        except Exception as e:
            self.log(f"Error setting up deeplink handling: {e}")

    def _setup_enhanced_plugin_search(self):
        try:
            from base_plugin import MethodHook
            from com.exteragram.messenger.plugins import PluginsController
            
            class PluginSearchHook(MethodHook):
                def __init__(self, quantahut):
                    self.quantahut = quantahut
                    self.matched_plugins = []
                    
                def before_hooked_method(self, param):
                    try:
                        activity = param.thisObject
                        searching = get_private_field(activity, "searching")
                        query = get_private_field(activity, "query")
                        
                        if not searching or not query:
                            self.matched_plugins = []
                            return
                            
                        query_lower = str(query).lower()
                        
                        plugins_controller = PluginsController.getInstance()
                        all_plugins = plugins_controller.plugins
                        
                        self.matched_plugins = []
                        keys_array = all_plugins.keySet().toArray()
                        
                        for i in range(len(keys_array)):
                            key = keys_array[i]
                            plugin = all_plugins.get(key)
                            if self.quantahut._matches_plugin_search(plugin, query_lower):
                                self.matched_plugins.append(plugin)
                        
                        for plugin in self.matched_plugins:
                            try:
                                name_field = plugin.getClass().getDeclaredField("name")
                                name_field.setAccessible(True)
                                original_name = name_field.get(plugin)
                                name_field.set(plugin, f"{original_name} {query_lower}")
                            except:
                                break
                        
                    except Exception as e:
                        self.quantahut.log(f"Plugin search error: {e}")
                
                def after_hooked_method(self, param):
                    try:
                        items = param.args[0]
                        activity = param.thisObject
                        
                        for plugin in self.matched_plugins:
                            try:
                                name_field = plugin.getClass().getDeclaredField("name")
                                name_field.setAccessible(True)
                                current_name = str(name_field.get(plugin))
                                if " " in current_name:
                                    original_name = current_name.rsplit(" ", 1)[0]
                                    name_field.set(plugin, original_name)
                            except:
                                pass
                        self.matched_plugins = []
                        
                        searching = get_private_field(activity, "searching")
                        if searching:
                            return
                        
                        current_filter = self.quantahut.current_filter
                        if current_filter != 0:
                            plugins_controller = PluginsController.getInstance()
                            plugin_items = []
                            other_items = []
                            PLUGIN_ID = 1
                            
                            for i in range(items.size()):
                                item = items.get(i)
                                if hasattr(item, 'id') and item.id == PLUGIN_ID:
                                    plugin_items.append(item)
                                else:
                                    other_items.append(item)
                            
                            filtered_items = []
                            for item in plugin_items:
                                plugin = item.plugin
                                if current_filter == 1 and plugin.isEnabled():
                                    filtered_items.append(item)
                                elif current_filter == 2 and not plugin.isEnabled():
                                    filtered_items.append(item)
                                elif current_filter == 3 and self.quantahut._is_recently_updated(plugin):
                                    filtered_items.append(item)
                                elif current_filter == 4 and plugins_controller.hasPluginSettings(plugin.getId()):
                                    filtered_items.append(item)
                                elif current_filter == 5 and plugin.hasError():
                                    filtered_items.append(item)
                            
                            items.clear()
                            for item in other_items:
                                items.add(item)
                            for item in filtered_items:
                                items.add(item)
                        
                        if self.quantahut.pills_container and items.size() > 0:
                            from org.telegram.ui.Components import UItem
                            try:
                                quantahut_log(f"Creating pills item, items.size()={items.size()}")
                                pills_item = UItem.asFullyCustom(self.quantahut.pills_container)
                                insert_position = 1 if items.size() > 1 else items.size()
                                items.add(insert_position, pills_item)
                            except:
                                pass
                    except:
                        pass
            
            class CreateViewHook(MethodHook):
                def __init__(self, quantahut):
                    self.quantahut = quantahut
                
                def after_hooked_method(self, param):
                    try:
                        activity = param.thisObject
                        context = param.args[0]
                        self.quantahut.stored_context = context
                        self.quantahut.stored_activity = activity
                        self.quantahut._add_filter_pills(activity)
                        run_on_ui_thread(lambda: self.quantahut._refresh_plugins_list(activity))
                    except:
                        pass
            
            PluginsActivityClass = find_class("com.exteragram.messenger.plugins.ui.PluginsActivity")
            if PluginsActivityClass:
                ContextClass = find_class("android.content.Context")
                create_view_method = PluginsActivityClass.getClass().getDeclaredMethod("createView", ContextClass)
                create_view_method.setAccessible(True)
                self.hook_refs.append(self.hook_method(create_view_method, CreateViewHook(self)))
                
                ArrayListClass = find_class("java.util.ArrayList")
                UniversalAdapterClass = find_class("org.telegram.ui.Components.UniversalAdapter")
                
                fill_items_method = PluginsActivityClass.getClass().getDeclaredMethod(
                    "fillItems", ArrayListClass, UniversalAdapterClass
                )
                fill_items_method.setAccessible(True)
                self.hook_refs.append(self.hook_method(fill_items_method, PluginSearchHook(self)))
                self.log("Enhanced plugin search enabled")
        except Exception as e:
            self.log(f"Failed to setup enhanced plugin search: {e}")
    
    def _matches_plugin_search(self, plugin, query):
        try:
            searchable = f"{plugin.getName()} {plugin.getAuthor()} {plugin.getDescription()} {plugin.getId()} {plugin.getVersion()}".lower()
            return query in searchable
        except:
            return False
    
    def _get_selected_branch(self):
        branch_index = self.get_setting("update_branch", DEFAULT_BRANCH)
        return "main" if branch_index == 0 else "Beta"
    
    def _on_restart_toggle_changed(self, enabled):
        try:
            self.set_setting("show_restart_menu", bool(enabled))
        except Exception:
            pass
        self._update_restart_menu_item()

    def _update_restart_menu_item(self):
        try:
            enabled = self.get_setting("show_restart_menu", DEFAULT_SHOW_RESTART_MENU)

            if self.restart_menu_item:
                self.remove_menu_item(self.restart_menu_item)
                self.restart_menu_item = None

            if enabled:
                self.restart_menu_item = self.add_menu_item(MenuItemData(
                    menu_type=MenuItemType.DRAWER_MENU,
                    text=get_string("quantahut_restart_drawer", "Restart App"),
                    icon="msg_retry",
                    priority=150,
                    on_click=self._on_restart_menu_clicked,
                ))
        except:
            pass

    def _on_restart_menu_clicked(self, context):
        try:
            fragment = get_last_fragment()
            restart_app(fragment)
        except Exception as e:
            quantahut_log(f"Error restarting app: {e}")





    def setup_hooks(self):
        try:
            _ensure_message_menu_hooks(self)
            self._setup_custom_badges_hooks()
            self._setup_custom_badges_hooks()
            
        except Exception as e:
            self.log(f"setup_hooks error: {str(e)}")


    def _clear_file_cache(self, view):
        github_localization.localization_cache.wipe()
        run_on_ui_thread(lambda: BulletinHelper.show_success("Cache cleared successfully"))

    def _reset_language_preference(self, view):
        try:
            from base_plugin import PluginsController
            from hook_utils import get_private_field
            from ui.bulletin import BulletinHelper
            prefs = get_private_field(PluginsController.getInstance(), "preferences")
            prefs.edit().remove("plugin_setting_ui_tweaks_selected_language").apply()
            run_on_ui_thread(lambda: BulletinHelper.show_success(get_string("language_pref_reset_success", "Language preference has been reset")))
        except Exception as e:
            try:
                from ui.bulletin import BulletinHelper
                run_on_ui_thread(lambda: BulletinHelper.show_error(get_string("language_pref_reset_failed", "Failed to reset language preference")))
            except Exception:
                pass
            quantahut_log(f"Error resetting language preference: {e}")

    def _get_cache_info_text(self):
        try:
            cache_content = github_localization.localization_cache.content
            languages = set()
            string_count = 0
            for key in cache_content.keys():
                if key.endswith('_timestamp'):
                    parts = key.rsplit('_', 2)
                    if len(parts) >= 2:
                        languages.add(parts[-2])
                elif '_' in key and not key.endswith('_timestamp'):
                    string_count += 1
            
            info_parts = []
            
            if languages:
                formatted_langs = []
                for lang in sorted(languages):
                    try:
                        from java.util import Locale
                        locale = Locale(lang)
                        formatted_langs.append(locale.getDisplayLanguage(locale).title())
                    except:
                        formatted_langs.append(lang.upper())
                
                lang_text = ', '.join(formatted_langs)
                info_parts.append(get_string("cache_info", "Cached {count} strings across languages: {languages}").format(count=string_count, languages=lang_text))
            
            if not info_parts:
                return get_string("cache_info", "No cached data")
            
            return " | ".join(info_parts)
        except Exception as e:
            return get_string("cache_info", "Cache status unavailable")

    def register_message_context_menu_item(self, *args, **kwargs):
        return utilities.register_message_menu_item(*args, **kwargs)

    def unregister_message_context_menu_item(self, handle):
        return utilities.unregister_message_menu_item(handle)

    def _check_for_updates_on_load(self):
        quantahut_log("Auto-checking for QuantaHut updates...")
        self._check_for_updates(show_on_load=True)
    
    def _check_for_updates(self, show_on_load=False):
        if self.checking_update:
            quantahut_log("Already checking for updates...")
            return
        
        self.checking_update = True
        
        def check_thread():
            try:
                quantahut_log("Checking for QuantaHut updates from GitHub...")
                
                branch_index = self.get_setting("update_branch", 0)
                branch = "main" if branch_index == 0 else "Beta"
                
                version_url = f"https://raw.githubusercontent.com/luvztroy/Auto-Update/refs/heads/{branch}/quantahut_changelog.json"
                quantahut_log(f"Fetching from {branch} branch: {version_url}")
                
                with urllib.request.urlopen(version_url, timeout=10) as response:
                    if response.getcode() != 200:
                        raise Exception(f"HTTP {response.getcode()}")
                    
                    version_data = json.loads(response.read().decode('utf-8'))
                    
                    self.latest_version = version_data.get("version", "0.0.0")
                    self.changelog = version_data.get("changelog_text", "No changelog available")
                    sticker_pack = version_data.get("sticker_pack")
                    sticker_index = version_data.get("sticker_index")
                    sticker_circle = version_data.get("sticker_circle", False)
                    sticker_size = version_data.get("sticker_size", 160)
                    
                    self.download_url = f"https://raw.githubusercontent.com/luvztroy/Auto-Update/refs/heads/{branch}/QuantaHut.plugin"
                    
                    quantahut_log(f"Latest version: {self.latest_version}")
                    quantahut_log(f"Current version: {__version__}")
                    
                    if self._is_newer_version(self.latest_version, __version__):
                        self.update_available = True
                        quantahut_log("QuantaHut update available!")
                        
                        if show_on_load:
                            run_on_ui_thread(lambda: self._show_update_bottom_sheet(
                                sticker_pack, sticker_index, sticker_circle, sticker_size
                            ))
                    else:
                        self.update_available = False
                        quantahut_log("QuantaHut is up to date")
                
            except Exception as e:
                quantahut_log(f"Error checking QuantaHut updates: {e}")
            finally:
                self.checking_update = False
        
        thread = threading.Thread(target=check_thread)
        thread.daemon = True
        thread.start()
    
    def _is_newer_version(self, latest: str, current: str) -> bool:
        try:
            def clean_version(version):
                version = version.split('-')[0].split(' ')[0].strip()
                return version
            
            latest_clean = clean_version(latest)
            current_clean = clean_version(current)
            
            latest_parts = [int(x) for x in latest_clean.split('.')]
            current_parts = [int(x) for x in current_clean.split('.')]
            
            max_len = max(len(latest_parts), len(current_parts))
            latest_parts += [0] * (max_len - len(latest_parts))
            current_parts += [0] * (max_len - len(current_parts))
            
            return latest_parts > current_parts
        except Exception as e:
            quantahut_log(f"Error comparing versions: {e}")
            return False
    
    def _show_update_bottom_sheet(self, sticker_pack, sticker_index, sticker_circle, sticker_size):
        if not self.update_available:
            return
        
        quantahut_log("Showing QuantaHut update bottom sheet")
        
        try:
            showupdatebottomsheet(
                title=f"QuantaHut Update: v{self.latest_version}",
                subtitle=f"Current version: {__version__}",
                description=self.changelog,
                sticker_pack=sticker_pack,
                sticker_index=sticker_index,
                sticker_circle=sticker_circle,
                sticker_size=sticker_size,
                button_text="Update Now",
                show_close_button=False,
                description_centered=False,
                on_button_click=self._download_and_install_update
            )
        except Exception as e:
            quantahut_log(f"Error showing QuantaHut update sheet: {e}")
    
    def _download_and_install_update(self):
        quantahut_log("Starting QuantaHut update download...")
        BulletinHelper.show_info("Downloading QuantaHut update...")
        
        def download_thread():
            try:
                with urllib.request.urlopen(self.download_url, timeout=30) as response:
                    plugin_content = response.read()
                
                from com.exteragram.messenger.plugins import PluginsController, PluginsConstants
                from org.telegram.messenger import ApplicationLoader, Utilities
                from java import dynamic_proxy, jclass
                
                plugins_dir = os.path.join(str(ApplicationLoader.applicationContext.getFilesDir()), "plugins")
                temp_file = os.path.join(plugins_dir, "quantahut_update.tmp")
                
                with open(temp_file, 'wb') as f:
                    f.write(plugin_content)
                
                try:
                    from org.telegram.messenger import LocaleController
                    lang = LocaleController.getInstance().getCurrentLocaleInfo().getLangCode()
                    if lang != "en":
                        github_localization.download_localization("UiTweaks", lang)
                except:
                    pass
                
                version = self.latest_version
                
                class Callback(dynamic_proxy(Utilities.Callback)):
                    def run(self_cb, error):
                        if error:
                            run_on_ui_thread(lambda: BulletinHelper.show_error(f"Update failed: {error}"))
                        else:
                            run_on_ui_thread(lambda: BulletinHelper.show_success(f"QuantaHut updated to v{version}!"))
                        try:
                            os.remove(temp_file)
                        except:
                            pass
                
                class Runnable(dynamic_proxy(jclass("java.lang.Runnable"))):
                    def run(self_r):
                        PluginsController.engines.get(PluginsConstants.PYTHON).loadPluginFromFile(temp_file, None, Callback())
                
                Utilities.pluginsQueue.postRunnable(Runnable())
                
            except Exception as e:
                run_on_ui_thread(lambda: BulletinHelper.show_error(f"Update failed: {e}"))
        
        threading.Thread(target=download_thread, daemon=True).start()




    def on_plugin_unload(self):
        for ref in self.hook_refs:
            if ref:
                try:
                    self.unhook_method(ref)
                except:
                    pass
        self.hook_refs.clear()
        
        if self.badge_hook_ref:
            self.unhook_method(self.badge_hook_ref)
            self.badge_hook_ref = None
        if self.developer_hook_ref:
            self.unhook_method(self.developer_hook_ref)
            self.developer_hook_ref = None
        if self.extera_hook_ref:
            self.unhook_method(self.extera_hook_ref)
            self.extera_hook_ref = None
            
        if self.settings_search_create_view_hook:
            self.unhook_method(self.settings_search_create_view_hook)
            self.settings_search_create_view_hook = None
            
        if self.settings_search_fill_items_hook:
            self.unhook_method(self.settings_search_fill_items_hook)
            self.settings_search_fill_items_hook = None
            
        self._search_state.clear()
        self._all_items_cache.clear()
        self._search_history.clear()
        self._activity_refs.clear()
        
        self.log("Plugin unloading...")

    def _setup_custom_badges_hooks(self):
        try:
            self._cache_classes()
            self._setup_badge_hook()
            self._load_custom_badges()
        except Exception as e:
            self.log(f"Error setting up custom badges hooks: {e}")
            
    def _cache_classes(self):
        try:
            self.TLRPC_User = find_class("org.telegram.tgnet.TLRPC$User")
            self.TLRPC_Chat = find_class("org.telegram.tgnet.TLRPC$Chat")
        except Exception as e:
            pass
            
    def _setup_badge_hook(self):
        try:
            BadgesController = find_class("com.exteragram.messenger.badges.BadgesController")
            if not BadgesController:
                return
                
            TLObject = find_class("org.telegram.tgnet.TLObject")
            method = BadgesController.getClass().getDeclaredMethod("getBadge", TLObject)
            method.setAccessible(True)
            
            self.badge_hook_ref = self.hook_method(method, CustomBadgeHook(self))
            
            TLRPC_User = find_class("org.telegram.tgnet.TLRPC$User")
            if TLRPC_User:
                is_developer_method = BadgesController.getClass().getDeclaredMethod("isDeveloper", TLRPC_User)
                is_developer_method.setAccessible(True)
                self.developer_hook_ref = self.hook_method(is_developer_method, CustomDeveloperHook(self))
            
            TLRPC_Chat = find_class("org.telegram.tgnet.TLRPC$Chat")
            if TLRPC_Chat:
                is_extera_method = BadgesController.getClass().getDeclaredMethod("isExtera", TLRPC_Chat)
                is_extera_method.setAccessible(True)
                self.extera_hook_ref = self.hook_method(is_extera_method, CustomExteraHook(self))
            
        except Exception as e:
            pass
            
    def _load_custom_badges(self):
        try:
            self.custom_badges.clear()
            import threading
            thread = threading.Thread(target=self._fetch_and_process_badges)
            thread.daemon = True
            thread.start()
        except Exception as e:
            pass
            
    def _fetch_and_process_badges(self):
        try:
            should_refresh = self._should_refresh_quantaconfig()
            badges_data = self._load_badges_from_config(force_refresh=should_refresh)
            if not badges_data:
                return
                
            BadgeDTO = find_class("com.exteragram.messenger.api.dto.BadgeDTO")
            if not BadgeDTO:
                return
                
            for badge_info in badges_data:
                badge_id = badge_info.get('id')
                user_id = badge_info.get('user_id')
                chat_id = badge_info.get('chat_id')
                emoji_id = badge_info.get('emoji_id')
                text_template = badge_info.get('text_template')
                
                if user_id and emoji_id and text_template:
                    user_name = self._get_user_name(user_id)
                    custom_text = text_template.format(user_name=user_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[user_id] = badge_dto
                    
                elif chat_id and emoji_id and text_template:
                    chat_name = self._get_chat_name(chat_id)
                    custom_text = text_template.format(chat_name=chat_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[chat_id] = badge_dto
                    
        except Exception as e:
            pass

    def _process_badges_from_data(self, badges_data):
        try:
            BadgeDTO = find_class("com.exteragram.messenger.api.dto.BadgeDTO")
            if not BadgeDTO:
                return
                
            for badge_info in badges_data:
                badge_id = badge_info.get('id')
                user_id = badge_info.get('user_id')
                chat_id = badge_info.get('chat_id')
                emoji_id = badge_info.get('emoji_id')
                text_template = badge_info.get('text_template')
                
                if user_id and emoji_id and text_template:
                    user_name = self._get_user_name(user_id)
                    custom_text = text_template.format(user_name=user_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[user_id] = badge_dto
                    
                elif chat_id and emoji_id and text_template:
                    chat_name = self._get_chat_name(chat_id)
                    custom_text = text_template.format(chat_name=chat_name)
                    badge_dto = BadgeDTO(emoji_id, custom_text)
                    self.custom_badges[chat_id] = badge_dto
                    
        except Exception as e:
            pass
            
    def _load_badges_from_config(self, force_refresh=False):
        try:
            cache_key = "quantaconfig_badges"
            timestamp_key = "quantaconfig_timestamp"
            
            if not force_refresh:
                cached_badges = github_localization.get_string_template(cache_key)
                if cached_badges:
                    return json.loads(cached_badges)
            
            quantahut_log("Downloading QuantaConfig from GitHub...")
            branch = self._get_selected_branch()
            github_url = f"https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/{branch}/QuantaConfig.json"
            
            with urllib.request.urlopen(github_url, timeout=10) as response:
                raw_data = response.read().decode('utf-8')
                data = json.loads(raw_data)
                badges = data.get('badges', [])
                
                github_localization.cache_text_template(cache_key, json.dumps(badges))
                github_localization.cache_text_template(timestamp_key, str(time.time()))
                return badges
                
        except urllib.error.URLError as e:
            return []
        except json.JSONDecodeError as e:
            return []
        except Exception as e:
            return []

    def _should_refresh_quantaconfig(self, max_age_hours=6):
        try:
            timestamp_key = "quantaconfig_timestamp"
            cached_timestamp = github_localization.get_string_template(timestamp_key)
            
            if not cached_timestamp:
                return True
            
            cached_time = float(cached_timestamp)
            current_time = time.time()
            age_hours = (current_time - cached_time) / 3600
            
            if age_hours > max_age_hours:
                return True
            
            return False
            
        except Exception as e:
            quantahut_log(f"Error checking cache age: {e}")
            return True
            
    def _get_user_name(self, user_id):
        try:
            from client_utils import get_messages_controller
            from org.telegram.messenger import UserObject
            user_obj = get_messages_controller().getUser(user_id)
            return UserObject.getUserName(user_obj) if user_obj else 'this user'
        except Exception as e:
            return 'this user'
            
    def _get_chat_name(self, chat_id):
        try:
            from client_utils import get_messages_controller
            chat_obj = get_messages_controller().getChat(chat_id)
            return chat_obj.title if chat_obj and hasattr(chat_obj, 'title') else 'this chat'
        except Exception as e:
            return 'this chat'

    def _load_available_languages(self):
        if getattr(self, '_languages_loading', False) or self.available_languages:
            return
            
        self._languages_loading = True
        
        def load_worker():
            try:
                import urllib.request, json
                from java.util import Locale
                from android_utils import run_on_ui_thread

                branch = self._get_selected_branch()
                url = f"https://api.github.com/repos/luvztroy/UiTweaks/contents/?ref={branch}"
                
                with urllib.request.urlopen(url) as response:
                    files = json.loads(response.read().decode('utf-8'))

                langs = []
                for f in files:
                    name = f.get('name', '')
                    if f.get('type') == 'file' and name.startswith('UiTweaks ') and name.endswith('.json'):
                        code = name[9:-5]
                        try:
                            loc = Locale(code)
                            display_name = loc.getDisplayLanguage(loc).title()
                        except:
                            display_name = code.upper()
                        langs.append({'code': code, 'display_name': display_name})
                
                langs.sort(key=lambda x: x['display_name'])
                
                def on_ui():
                    self.available_languages = langs
                    global available_languages
                    available_languages = langs
                    self._languages_loading = False
                    quantahut_log(f"Loaded {len(langs)} available languages")
                
                run_on_ui_thread(on_ui)
                
            except Exception as e:
                self._languages_loading = False
                quantahut_log(f"Error loading languages: {e}")

        import threading
        threading.Thread(target=load_worker, daemon=True).start()

    def _setup_quanta_file_hook(self):
        try:
            from java.lang import Class
            from java import jclass
            AndroidUtilitiesClass = Class.forName("org.telegram.messenger.AndroidUtilities")
            MessageObjectClass = Class.forName("org.telegram.messenger.MessageObject")
            ActivityClass = Class.forName("android.app.Activity")
            ResourcesProviderClass = Class.forName("org.telegram.ui.ActionBar.Theme$ResourcesProvider")
            open_for_view = AndroidUtilitiesClass.getDeclaredMethod(
                "openForView",
                MessageObjectClass,
                ActivityClass,
                ResourcesProviderClass,
                jclass("java.lang.Boolean").TYPE,
            )
            open_for_view.setAccessible(True)
            class OpenForViewHook:
                def __init__(hook_self):
                    hook_self.plugin = self
                def before_hooked_method(hook_self, param):
                    try:
                        if len(param.args) >= 1:
                            msg = param.args[0]
                            if msg and hasattr(msg, "getDocumentName"):
                                name = msg.getDocumentName()
                                if name:
                                    name_lower = str(name).lower()
                                    if name_lower.endswith(".backup"):
                                        hook_self.plugin.log(f"Detected .backup file click: {name}")
                                        hook_self.plugin._show_import_bottom_sheet(msg)
                                        param.setResult(False)
                                    elif name_lower.endswith(".plugins"):
                                        hook_self.plugin.log(f"Detected .plugins file click: {name}")
                                        hook_self.plugin._show_import_plugins_bottom_sheet(msg)
                                        param.setResult(False)
                    except Exception as e:
                        pass
            self.hook_refs.append(self.hook_method(open_for_view, OpenForViewHook()))
        except Exception as e:
            pass

    def _show_import_bottom_sheet(self, message_object):
        def show_sheet():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from file_utils import read_file
                from com.exteragram.messenger.plugins import PluginsController
                
                changes_count = 0
                try:
                    file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                    if file_path:
                        content = read_file(file_path)
                        if content:
                            backup_data = json.loads(content)
                            all_settings = backup_data.get("plugins", {})
                            controller = PluginsController.getInstance()
                            
                            for plugin_id, plugin_data in all_settings.items():
                                if controller.plugins.containsKey(plugin_id):
                                    settings = plugin_data.get("settings", {})
                                    engine = controller.getPluginEngine(plugin_id)
                                    if engine and settings:
                                        current_settings = engine.getAllPluginSettings(plugin_id)
                                        for key, value in settings.items():
                                            current_value = current_settings.get(key) if current_settings else None
                                            if current_value != value:
                                                changes_count += 1
                except Exception:
                    changes_count = 1
                
                if changes_count == 0:
                    BulletinHelper.show_error(get_string("settings_same_as_current", "It looks like the settings are the same as the current ones."))
                    return
                
                subtitle = get_string("changes_will_be_applied_singular", "{count} change will be applied to the current settings.").format(count=changes_count) if changes_count == 1 else get_string("changes_will_be_applied_plural", "{count} changes will be applied to the current settings.").format(count=changes_count)
                
                def on_import_click():
                    self._import_from_message(message_object)
                
                showupdatebottomsheet(
                    title=get_string("apply_settings_confirmation", "Are you sure you want to apply these settings?"),
                    subtitle=subtitle,
                    button_text=get_string("yes_apply", "Yes, apply"),
                    button2_text=get_string("no_leave_as_is", "No, leave as is"),
                    show_close_button=False,
                    raw_resource=R_tg.raw.email_check_inbox,
                    on_button_click=on_import_click,
                    on_button2_click=lambda: None
                )
                
            except Exception as e:
                pass
        
        run_on_ui_thread(show_sheet)

    def _import_from_message(self, message_object):
        try:
            from com.exteragram.messenger.utils import ChatUtils
            from file_utils import read_file
            from com.exteragram.messenger.plugins import PluginsController
            
            file_path = ChatUtils.getInstance().getPathToMessage(message_object)
            if not file_path:
                return
            
            content = read_file(file_path)
            if not content:
                return
            
            backup_data = json.loads(content)
            all_settings = backup_data.get("plugins", {})
            controller = PluginsController.getInstance()
            imported_count = 0
            
            for plugin_id, plugin_data in all_settings.items():
                if controller.plugins.containsKey(plugin_id):
                    settings = plugin_data.get("settings", {})
                    engine = controller.getPluginEngine(plugin_id)
                    
                    if engine and settings:
                        for key, value in settings.items():
                            try:
                                engine.setPluginSetting(plugin_id, key, value)
                                imported_count += 1
                            except Exception:
                                pass
                        
                        controller.loadPluginSettings(plugin_id)
            
            BulletinHelper.show_success(get_string("imported_settings_from_plugins", "Imported settings from {count} plugins").format(count=len(all_settings)))
            
        except Exception as e:
            BulletinHelper.show_error(get_string("failed_to_import_settings", "Failed to import settings"))

    def _export_all_settings(self, view):
        export_all_plugin_settings()
    
    def _toggle_branch_selector(self, view):
        current = self.get_setting("show_branch_selector", False)
        self.set_setting("show_branch_selector", not current, reload_settings=True)
        
        if not current:
            BulletinHelper.show_success(get_string("branch_selector_enabled", "Branch selector enabled!"))
        else:
            BulletinHelper.show_info(get_string("branch_selector_disabled", "Branch selector hidden"))
    
    def _export_all_plugins(self, view):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            controller = PluginsController.getInstance()
            plugins_dir = controller.pluginsDir
            plugin_files = plugins_dir.listFiles()
            
            if not plugin_files or len(plugin_files) == 0:
                BulletinHelper.show_error(get_string("no_plugins_to_export", "No plugins to export"))
                return
            
            plugin_ids = [str(f.getName()).replace(".py", "") for f in plugin_files if f.isFile() and str(f.getName()).endswith(".py")]
            self._export_plugins_by_ids(plugin_ids, "Plugins Backup")
        except Exception as e:
            self.log(f"Error exporting plugins: {e}")
            BulletinHelper.show_error(get_string("failed_to_export_plugins", "Failed to export plugins"))
    
    def _export_plugins_by_ids(self, plugin_ids, prefix="Plugins"):
        try:
            from file_utils import get_cache_dir
            from com.exteragram.messenger.plugins import PluginsController
            from org.telegram.messenger import Utilities
            from java.io import File, FileOutputStream
            from java.util.zip import ZipOutputStream, ZipEntry
            from java.nio.file import Files
            from android.content import Intent
            from android.net import Uri
            from org.telegram.ui import LaunchActivity
            from java.text import SimpleDateFormat
            from java.util import Date
            
            controller = PluginsController.getInstance()
            cache_dir = get_cache_dir()
            random_str = Utilities.generateRandomString(4)
            formatter = SimpleDateFormat("yyyy-MM-dd_HH-mm")
            timestamp = formatter.format(Date())
            zip_filename = f"{prefix} {timestamp} {random_str}.plugins"
            zip_file_path = os.path.join(cache_dir, zip_filename)
            
            zip_file = File(zip_file_path)
            if zip_file.exists():
                zip_file.delete()
            
            fos = FileOutputStream(zip_file)
            zos = ZipOutputStream(fos)
            
            exported_count = 0
            for plugin_id in plugin_ids:
                try:
                    plugin_path = controller.getPluginPath(plugin_id)
                    if plugin_path:
                        plugin_file = File(plugin_path)
                        if plugin_file.exists():
                            entry = ZipEntry(plugin_file.getName())
                            zos.putNextEntry(entry)
                            file_bytes = Files.readAllBytes(plugin_file.toPath())
                            zos.write(file_bytes)
                            zos.closeEntry()
                            exported_count += 1
                except Exception as e:
                    self.log(f"Failed to export {plugin_id}: {e}")
            
            zos.close()
            fos.close()
            
            if exported_count == 0:
                BulletinHelper.show_error(get_string("no_plugins_exported", "No plugins were exported"))
                return
            
            def open_share():
                try:
                    from org.telegram.messenger import ApplicationLoader
                    context = ApplicationLoader.applicationContext
                    file_uri = Uri.fromFile(zip_file)
                    
                    intent = Intent(context, LaunchActivity)
                    intent.setAction(Intent.ACTION_SEND)
                    intent.setType("application/octet-stream")
                    intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                    intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                    intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                    
                    context.startActivity(intent)
                    BulletinHelper.show_success(get_string("exported_plugins_count", "Exported {count} plugins").format(count=exported_count))
                except Exception as e:
                    self.log(f"Error sharing: {e}")
            
            run_on_ui_thread(open_share)
        except Exception as e:
            self.log(f"Error exporting plugins: {e}")
            BulletinHelper.show_error(get_string("failed_to_export_plugins", "Failed to export plugins"))
    
    def _add_filter_pills(self, activity):
        try:
            if self.pills_container:
                return
            if not self.stored_context:
                return
            context = self.stored_context
            from android.widget import HorizontalScrollView
            from android.graphics.drawable import GradientDrawable
            from android.util import TypedValue
            from android_utils import OnClickListener
            scroll_view = HorizontalScrollView(context)
            scroll_view.setHorizontalScrollBarEnabled(False)
            scroll_view.setClipToPadding(False)
            pills_layout = LinearLayout(context)
            pills_layout.setOrientation(LinearLayout.HORIZONTAL)
            pills_layout.setPadding(int(AndroidUtilities.dp(12)), int(AndroidUtilities.dp(15)), int(AndroidUtilities.dp(12)), int(AndroidUtilities.dp(8)))
            filters = [
                (get_string("filter_all", "All"), 0),
                (get_string("filter_recently_updated", "Recently Updated"), 3),
                (get_string("filter_enabled", "Enabled"), 1),
                (get_string("filter_disabled", "Disabled"), 2),
                (get_string("filter_has_settings", "Has Settings"), 4),
                (get_string("filter_errors", "Errors"), 5)
            ]
            self.filter_pills = []
            self.filter_base_texts = {}
            for text, filter_id in filters:
                self.filter_base_texts[filter_id] = text
                pill = self._create_pill(text, filter_id, context)
                pills_layout.addView(pill)
                self.filter_pills.append((pill, filter_id))
            scroll_view.addView(pills_layout)
            self.pills_container = scroll_view
            self._update_pill_counts()
            self._update_pill_states()
        except:
            pass
    
    def _create_pill(self, text, filter_id, context):
        from android.graphics.drawable import GradientDrawable
        from android.util import TypedValue
        from android_utils import OnClickListener
        pill = TextView(context)
        pill.setText(text)
        pill.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        pill.setGravity(Gravity.CENTER)
        pill.setPadding(int(AndroidUtilities.dp(16)), int(AndroidUtilities.dp(6)), int(AndroidUtilities.dp(16)), int(AndroidUtilities.dp(6)))
        margin = int(AndroidUtilities.dp(4))
        lp = LinearLayout.LayoutParams(LinearLayout.LayoutParams.WRAP_CONTENT, LinearLayout.LayoutParams.WRAP_CONTENT)
        lp.setMargins(margin, 0, margin, 0)
        pill.setLayoutParams(lp)
        drawable = GradientDrawable()
        drawable.setCornerRadius(AndroidUtilities.dp(16))
        pill.setBackground(drawable)
        pill.setOnClickListener(self._create_pill_click_listener(filter_id))
        pill.setOnLongClickListener(self._create_pill_long_click_listener(filter_id, pill))
        
        return pill
    
    def _create_pill_click_listener(self, filter_id):
        plugin = self
        def on_click(view=None):
            try:
                plugin.current_filter = filter_id
                plugin._update_pill_states()
                plugin._refresh_plugins_list(plugin.stored_activity)
            except:
                pass
        from android_utils import OnClickListener
        return OnClickListener(on_click)
    
    def _create_pill_long_click_listener(self, filter_id, pill_view):
        plugin = self
        def on_long_click(view=None):
            try:
                perform_haptic()
                plugin._show_filter_menu(filter_id, pill_view)
                return True
            except Exception as e:
                plugin.log(f"Error in pill long click: {e}")
                return False
        from android_utils import OnLongClickListener
        return OnLongClickListener(on_long_click)
    
    def _show_filter_menu(self, filter_id, anchor_view):
        try:
            from org.telegram.ui.ActionBar import ActionBarPopupWindow, ActionBarMenuSubItem
            from org.telegram.messenger import R as R_tg
            from android_utils import OnClickListener
            from android.view import Gravity
            
            popup_layout = ActionBarPopupWindow.ActionBarPopupWindowLayout(self.stored_context, R_tg.drawable.popup_fixed_alert2, None)
            popup_window = [None]
            
            export_item = ActionBarMenuSubItem(self.stored_context, True, False, None)
            export_item.setTextAndIcon(get_string("export_plugins_in_filter", "Export Plugins"), R_tg.drawable.msg_shareout)
            export_item.setOnClickListener(OnClickListener(lambda v=None: (popup_window[0].dismiss(), self._export_filter_plugins(filter_id))))
            popup_layout.addView(export_item)
            
            delete_item = ActionBarMenuSubItem(self.stored_context, False, True, None)
            delete_item.setTextAndIcon(get_string("delete_plugins_in_filter", "Delete Plugins"), R_tg.drawable.msg_delete)
            delete_item.setColors(Theme.getColor(Theme.key_text_RedBold), Theme.getColor(Theme.key_text_RedRegular))
            delete_item.setOnClickListener(OnClickListener(lambda v=None: (popup_window[0].dismiss(), self._confirm_delete_filter_plugins(filter_id))))
            popup_layout.addView(delete_item)
            
            popup_window[0] = ActionBarPopupWindow(popup_layout, -2, -2)
            popup_window[0].setOutsideTouchable(True)
            popup_window[0].setClippingEnabled(True)
            popup_window[0].setAnimationStyle(R_tg.style.PopupContextAnimation)
            popup_window[0].setFocusable(True)
            
            location = [0, 0]
            anchor_view.getLocationInWindow(location)
            popup_window[0].showAtLocation(anchor_view, Gravity.LEFT | Gravity.TOP, location[0], location[1] + anchor_view.getHeight())
        except Exception as e:
            self.log(f"Error showing menu: {e}")
    
    def _export_filter_plugins(self, filter_id):
        try:
            from android_utils import run_on_ui_thread
            
            plugin_ids = self._get_plugins_in_filter(filter_id)
            if not plugin_ids:
                run_on_ui_thread(lambda: BulletinHelper.show_info(get_string("no_plugins_in_filter", "No plugins in this filter")))
                return
            
            filter_name = self.filter_base_texts.get(filter_id, "")
            self._export_plugins_by_ids(plugin_ids, filter_name)
        except Exception as e:
            self.log(f"Error exporting filter plugins: {e}")
    
    def _confirm_delete_filter_plugins(self, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            from android_utils import run_on_ui_thread
            
            filter_name = self.filter_base_texts.get(filter_id, "")
            plugin_ids = self._get_plugins_in_filter(filter_id)
            
            if not plugin_ids:
                run_on_ui_thread(lambda: BulletinHelper.show_info(get_string("no_plugins_in_filter", "No plugins in this filter")))
                return
            
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            
            plugin_names = []
            plugin_id_map = {}
            
            for plugin_id in plugin_ids:
                plugin = all_plugins.get(plugin_id)
                if plugin:
                    name = str(plugin.getName())
                    plugin_names.append(name)
                    plugin_id_map[name] = plugin_id
            
            def on_delete_clicked(selected_keys):
                selected_ids = [plugin_id_map[key] for key in selected_keys if key in plugin_id_map]
                if selected_ids:
                    self._delete_filter_plugins(selected_ids)
            
            def show_selector():
                showmultiselector(
                    items=plugin_names,
                    title=get_string("select_plugins_to_delete", "Select Plugins to Delete"),
                    subtitle=get_string("select_plugins_subtitle", "Choose which plugins to remove from {filter}").format(filter=filter_name),
                    setting_keys=plugin_names,
                    plugin_instance=self,
                    on_action_click=on_delete_clicked,
                    action_text=get_string("delete", "Delete"),
                    show_count=False,
                    show_select_all=True
                )
            
            run_on_ui_thread(show_selector)
        except Exception as e:
            self.log(f"Error showing delete selector: {e}")
    
    def _get_plugins_in_filter(self, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            filtered_plugins = []
            
            for key in all_plugins.keySet().toArray():
                plugin = all_plugins.get(key)
                if plugin and self._plugin_matches_filter(plugin, filter_id):
                    filtered_plugins.append(str(plugin.getId()))
            
            return filtered_plugins
        except Exception as e:
            self.log(f"Error getting plugins in filter: {e}")
            return []
    
    def _plugin_matches_filter(self, plugin, filter_id):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            
            if filter_id == 0:
                return True
            elif filter_id == 1:
                return plugin.isEnabled()
            elif filter_id == 2:
                return not plugin.isEnabled()
            elif filter_id == 3:
                return self._is_recently_updated(plugin)
            elif filter_id == 4:
                return plugins_controller.hasPluginSettings(plugin.getId())
            elif filter_id == 5:
                return plugin.hasError()
            return False
        except:
            return False
    
    def _delete_filter_plugins(self, plugin_ids):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            from android_utils import run_on_ui_thread
            
            plugins_controller = PluginsController.getInstance()
            count = len(plugin_ids)
            
            def on_complete(error):
                def update_ui():
                    if self.stored_activity:
                        list_view = get_private_field(self.stored_activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)
                    
                    if error:
                        BulletinHelper.show_error(str(error))
                    else:
                        msg = get_string("deleted_plugins_count", "Deleted {count} plugins").format(count=count)
                        BulletinHelper.show_success(msg)
                
                run_on_ui_thread(update_ui)
            
            for i, plugin_id in enumerate(plugin_ids):
                is_last = (i == len(plugin_ids) - 1)
                plugins_controller.deletePlugin(plugin_id, Callback1(on_complete) if is_last else None)
        except Exception as e:
            self.log(f"Error deleting plugins: {e}")
            run_on_ui_thread(lambda: BulletinHelper.show_error(get_string("failed_to_delete_plugins", "Failed to delete plugins")))
    
    def _get_plugin_counts(self):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            all_plugins = plugins_controller.plugins
            counts = {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0}
            
            for key in all_plugins.keySet().toArray():
                plugin = all_plugins.get(key)
                if plugin:
                    counts[0] += 1
                    if plugin.isEnabled():
                        counts[1] += 1
                    else:
                        counts[2] += 1
                    if self._is_recently_updated(plugin):
                        counts[3] += 1
                    if plugins_controller.hasPluginSettings(plugin.getId()):
                        counts[4] += 1
                    if plugin.hasError():
                        counts[5] += 1
            return counts
        except:
            return {0: 0, 1: 0, 2: 0, 3: 0, 4: 0, 5: 0}
    
    def _update_pill_counts(self):
        try:
            if not hasattr(self, 'filter_base_texts'):
                return
            
            counts = self._get_plugin_counts()
            
            for pill, filter_id in self.filter_pills:
                base_text = self.filter_base_texts.get(filter_id, "")
                count = counts.get(filter_id, 0)
                pill.setText(f"{base_text} - {count}")
        except:
            pass
    
    def _update_pill_states(self):
        try:
            from android.graphics.drawable import GradientDrawable
            from androidx.core.graphics import ColorUtils
            for pill, filter_id in self.filter_pills:
                is_selected = (filter_id == self.current_filter)
                if is_selected:
                    pill.setTextColor(Theme.getColor(Theme.key_actionBarTabActiveText))
                    drawable = pill.getBackground()
                    if isinstance(drawable, GradientDrawable):
                        base_color = Theme.getColor(Theme.key_actionBarTabLine)
                        drawable.setColor(ColorUtils.setAlphaComponent(base_color, 0x1F))
                else:
                    pill.setTextColor(Theme.getColor(Theme.key_actionBarTabUnactiveText))
                    drawable = pill.getBackground()
                    if isinstance(drawable, GradientDrawable):
                        drawable.setColor(Theme.getColor(Theme.key_windowBackgroundWhite))
                        drawable.setStroke(AndroidUtilities.dp(1), Theme.getColor(Theme.key_divider))
        except:
            pass
    
    def _refresh_plugins_list(self, activity):
        try:
            self._update_pill_counts()
            list_view = get_private_field(activity, "listView")
            if list_view and list_view.adapter:
                run_on_ui_thread(lambda: list_view.adapter.update(True))
        except:
            pass
    
    def _is_recently_updated(self, plugin):
        try:
            from com.exteragram.messenger.plugins import PluginsController
            plugins_controller = PluginsController.getInstance()
            plugin_path = plugins_controller.getPluginPath(plugin.getId())
            
            if not plugin_path:
                return False
            
            plugin_file = File(plugin_path)
            if not plugin_file.exists():
                return False
            
            last_modified = plugin_file.lastModified()
            current_time = int(time.time() * 1000)
            one_day_ms = 24 * 60 * 60 * 1000
            
            return (current_time - last_modified) <= one_day_ms
        except:
            return False
    
    def _show_import_plugins_bottom_sheet(self, message_object):
        def show_sheet():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from com.exteragram.messenger.plugins import PluginsController
                
                file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                if not file_path:
                    return
                
                from java.io import File
                from java.util.zip import ZipFile
                from java.util import Collections
                
                zip_file = ZipFile(File(file_path))
                entries_list = Collections.list(zip_file.entries())
                
                plugin_count = 0
                for i in range(entries_list.size()):
                    entry = entries_list.get(i)
                    if not entry.isDirectory() and str(entry.getName()).endswith(".py"):
                        plugin_count += 1
                
                zip_file.close()
                
                if plugin_count == 0:
                    BulletinHelper.show_error(get_string("no_plugins_in_file", "No plugins found in file"))
                    return
                
                subtitle = get_string("plugins_will_be_imported_singular", "{count} plugin will be imported.").format(count=plugin_count) if plugin_count == 1 else get_string("plugins_will_be_imported_plural", "{count} plugins will be imported.").format(count=plugin_count)
                
                def on_import_click():
                    self._import_plugins_from_message(message_object)
                
                showupdatebottomsheet(
                    title=get_string("import_plugins_confirmation", "Import Plugins?"),
                    subtitle=subtitle,
                    description=get_string("import_plugins_description", "Existing plugins with the same name will be replaced."),
                    button_text=get_string("yes_import", "Yes, import"),
                    button2_text=get_string("cancel", "Cancel"),
                    show_close_button=False,
                    raw_resource=R_tg.raw.email_check_inbox,
                    on_button_click=on_import_click,
                    on_button2_click=lambda: None
                )
                
            except Exception as e:
                self.log(f"Error showing import sheet: {e}")
                BulletinHelper.show_error(get_string("failed_to_read_plugins_file", "Failed to read plugins file"))
        
        run_on_ui_thread(show_sheet)
    
    def _import_plugins_from_message(self, message_object):
        loading_dialog = [None]
        loading_view = [None]
        done = [False]
        start_time = [-1]
        
        def show_loading_dialog():
            try:
                from ui.alert import AlertDialogBuilder
                from android_utils import run_on_ui_thread
                from client_utils import get_last_fragment
                from com.exteragram.messenger.speech.ui import LoadingModelView
                
                context = get_last_fragment().getParentActivity()
                loading_view[0] = LoadingModelView(context)
                
                try:
                    loading_view_class = loading_view[0].getClass()
                    
                    title_field = loading_view_class.getDeclaredField("title")
                    title_field.setAccessible(True)
                    title_view = title_field.get(loading_view[0])
                    title_view.setText(get_string("importing_plugins", "Importing plugins..."))
                    
                    subtitle_field = loading_view_class.getDeclaredField("subtitle")
                    subtitle_field.setAccessible(True)
                    subtitle_view = subtitle_field.get(loading_view[0])
                    subtitle_view.setText(get_string("importing_plugins_info", "Please keep this window open while plugins are importing."))
                except Exception as e:
                    quantahut_log(f"Could not change loading view text: {e}")
                
                from org.telegram.ui.ActionBar import AlertDialog
                builder = AlertDialog.Builder(context)
                builder.setView(loading_view[0])
                dialog = builder.create()
                dialog.setCanceledOnTouchOutside(False)
                dialog.setCancelable(False)
                loading_dialog[0] = dialog
                
                def delayed_show():
                    if not done[0]:
                        start_time[0] = int(time.time() * 1000)
                        dialog.show()
                
                run_on_ui_thread(delayed_show, 150)
            except Exception as e:
                quantahut_log(f"Error showing loading dialog: {e}")
        
        run_on_ui_thread(show_loading_dialog)
        
        def do_import():
            try:
                from com.exteragram.messenger.utils import ChatUtils
                from com.exteragram.messenger.plugins import PluginsController, PluginsConstants
                from java.io import File, FileOutputStream
                from java.util.zip import ZipFile
                from java.nio.file import Files
                
                file_path = ChatUtils.getInstance().getPathToMessage(message_object)
                if not file_path:
                    return
                
                controller = PluginsController.getInstance()
                plugins_dir = controller.pluginsDir
                
                from java.util import Collections
                
                zip_file = ZipFile(File(file_path))
                entries_list = Collections.list(zip_file.entries())
                total_plugins = sum(1 for i in range(entries_list.size()) if not entries_list.get(i).isDirectory() and str(entries_list.get(i).getName()).endswith(".py"))
                
                imported_count = 0
                skipped_count = 0
                processed_count = 0
                
                def update_import_progress():
                    if loading_view[0] and total_plugins > 0:
                        try:
                            progress = float(processed_count) / float(total_plugins)
                            def update_progress(prog=progress, view=loading_view[0]):
                                try:
                                    if view:
                                        view.setProgress(prog)
                                except:
                                    pass
                            run_on_ui_thread(update_progress)
                        except:
                            pass
                
                for i in range(entries_list.size()):
                    entry = entries_list.get(i)
                    if not entry.isDirectory() and str(entry.getName()).endswith(".py"):
                        try:
                            plugin_id = str(entry.getName()).replace(".plugin", "").replace(".py", "")
                            existing = controller.plugins.get(plugin_id)
         
                            if existing:
                                input_stream = zip_file.getInputStream(entry)
                                from java.io import BufferedReader, InputStreamReader
                                reader = BufferedReader(InputStreamReader(input_stream, "UTF-8"))
                                content = ""
                                line = reader.readLine()
                                while line is not None:
                                    content += line + "\n"
                                    line = reader.readLine()
                                reader.close()
                                
                                backup_ver = [line.split('=', 1)[1].strip(' "\'\n') for line in content.split('\n') if '__version__' in line and '=' in line and len(line.split('=', 1)) >= 2][:1]
                                
                                if backup_ver and existing.getVersion() >= backup_ver[0]:
                                    skipped_count += 1
                                    processed_count += 1
                                    self.log(f"Skipped {plugin_id} (same or newer version: installed={existing.getVersion()}, backup={backup_ver[0]})")
                                    update_import_progress()
                                    continue
                            
                            input_stream = zip_file.getInputStream(entry)
                            output_file = File(plugins_dir, entry.getName())
                            
                            from java.nio.file import Files as NIOFiles
                            from java.nio.file import StandardCopyOption
                            
                            NIOFiles.copy(input_stream, output_file.toPath(), StandardCopyOption.REPLACE_EXISTING)
                            input_stream.close()
                            imported_count += 1
                            self.log(f"Imported {plugin_id} successfully")
                        except Exception as e:
                            self.log(f"Error importing {entry.getName()}: {e}")
                        finally:
                            processed_count += 1
                            update_import_progress()
                
                zip_file.close()
                
                done[0] = True
                if loading_view[0]:
                    def set_complete(view=loading_view[0]):
                        try:
                            if view:
                                view.setProgress(1.0)
                        except:
                            pass
                    run_on_ui_thread(set_complete)
                
                def dismiss_dialog():
                    try:
                        dialog = loading_dialog[0]
                        start = start_time[0]
                        if dialog and hasattr(dialog, 'isShowing') and dialog.isShowing():
                            if start > 0:
                                delay = max(0, 1000 - (int(time.time() * 1000) - start))
                                def do_dismiss(d=dialog):
                                    try:
                                        d.dismiss()
                                    except:
                                        pass
                                run_on_ui_thread(do_dismiss, delay)
                            else:
                                dialog.dismiss()
                    except:
                        pass
                
                if imported_count > 0:
                    def reload_plugins():
                        try:
                            python_engine = PluginsController.engines.get(PluginsConstants.PYTHON)
                            if python_engine:
                                from android_utils import R
                                
                                def reload_callback():
                                    dismiss_dialog()
                                    msg = get_string("imported_plugins_count_reloaded", "Imported {count} plugins successfully!").format(count=imported_count)
                                    if skipped_count > 0:
                                        msg += " " + get_string("plugins_skipped_count", "({count} skipped)").format(count=skipped_count)
                                    run_on_ui_thread(lambda: BulletinHelper.show_success(msg))
                                
                                python_engine.loadPlugins(R(reload_callback))
                        except Exception as e:
                            self.log(f"Error reloading plugins: {e}")
                    
                    reload_plugins()
                else:
                    dismiss_dialog()
                    if skipped_count > 0:
                        run_on_ui_thread(lambda: BulletinHelper.show_info(get_string("no_plugins_imported_skipped", "No plugins imported ({count} skipped - same or newer version)").format(count=skipped_count)))
                    else:
                        run_on_ui_thread(lambda: BulletinHelper.show_error(get_string("no_plugins_imported", "No plugins were imported")))
                    
            except Exception as e:
                self.log(f"Error importing plugins: {e}")
                run_on_ui_thread(lambda: BulletinHelper.show_error(get_string("failed_to_import_plugins", "Failed to import plugins")))
        
        run_on_queue(do_import)

    def _setup_plugin_settings_search(self):
        try:
            PluginSettingsActivity = find_class("com.exteragram.messenger.plugins.ui.PluginSettingsActivity")
            if not PluginSettingsActivity:
                return

            Context = jclass("android.content.Context")
            create_view_method = PluginSettingsActivity.getClass().getDeclaredMethod("createView", Context.getClass())
            create_view_method.setAccessible(True)
            self.settings_search_create_view_hook = self.hook_method(create_view_method, _PluginSettingsSearchCreateViewHook(self))

            ArrayList = jclass("java.util.ArrayList")
            UniversalAdapter = jclass("org.telegram.ui.Components.UniversalAdapter")
            fill_items_method = PluginSettingsActivity.getClass().getDeclaredMethod("fillItems", ArrayList, UniversalAdapter)
            fill_items_method.setAccessible(True)
            self.settings_search_fill_items_hook = self.hook_method(fill_items_method, _PluginSettingsSearchFillItemsHook(self))

        except Exception as e:
            pass

    def get_search_state(self, activity_id):
        if activity_id not in self._search_state:
            self._search_state[activity_id] = {"query": "", "active": False, "reset_hidden": False, "show_history": False}
        return self._search_state[activity_id]

    def get_search_history(self, plugin_id):
        if plugin_id not in self._search_history:
            history_str = self.get_setting(f"search_history_{plugin_id}", "")
            if history_str:
                try:
                    self._search_history[plugin_id] = json.loads(history_str)
                except:
                    self._search_history[plugin_id] = []
            else:
                self._search_history[plugin_id] = []
        return self._search_history[plugin_id]

    def add_to_history(self, plugin_id, query):
        query = query.strip()
        if not query or len(query) < 2:
            return
        
        history = self.get_search_history(plugin_id)
        if query in history:
            history.remove(query)
        history.insert(0, query)
        
        while len(history) > MAX_HISTORY:
            history.pop()
        
        self._search_history[plugin_id] = history
        self.set_setting(f"search_history_{plugin_id}", json.dumps(history))

    def _matches_query(self, item, query):
        if getattr(item, "viewType", -1) in (0, 7):
            return False

        if query in str(getattr(item, "object2", "") or "").lower():
            return True

        setting = getattr(item, "settingItem", None)
        if setting:
            for attr in ["text", "hint", "key"]:
                val = getattr(setting, attr, None)
                if val and query in str(val).lower():
                    return True

        for attr in ["text", "subtext", "textValue", "animatedText"]:
            val = getattr(item, attr, None)
            if val and query in str(val).lower():
                return True

        return False

    def _create_uitem_from_py_object(self, py_obj, plugin):
        try:
            UItem = jclass("org.telegram.ui.Components.UItem")
            PC = jclass("com.exteragram.messenger.plugins.PluginsController")
            AppLoader = jclass("org.telegram.messenger.ApplicationLoader")
            
            TextSetting = jclass("com.exteragram.messenger.plugins.models.TextSetting")
            SwitchSetting = jclass("com.exteragram.messenger.plugins.models.SwitchSetting")
            SelectorSetting = jclass("com.exteragram.messenger.plugins.models.SelectorSetting")
            InputSetting = jclass("com.exteragram.messenger.plugins.models.InputSetting")
            HeaderSetting = jclass("com.exteragram.messenger.plugins.models.HeaderSetting")
            DividerSetting = jclass("com.exteragram.messenger.plugins.models.DividerSetting")
            EditTextSetting = jclass("com.exteragram.messenger.plugins.models.EditTextSetting")

            cls_name = py_obj.__class__.__name__
            key = getattr(py_obj, 'key', None)
            text = getattr(py_obj, 'text', None)
            
            icon = getattr(py_obj, 'icon', None)
            icon_res = 0
            if icon:
                ctx = AppLoader.applicationContext
                icon_res = ctx.getResources().getIdentifier(icon, "drawable", ctx.getPackageName())

            on_long_click = getattr(py_obj, 'on_long_click', None)
            link_alias = getattr(py_obj, 'link_alias', None)

            item = None
            setting = None

            if cls_name == 'Header':
                if text:
                    setting = HeaderSetting(text)
                    item = UItem.asHeader(text)

            elif cls_name == 'Switch':
                if key and text:
                    default = getattr(py_obj, 'default', False) or False
                    subtext = getattr(py_obj, 'subtext', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = SwitchSetting(key, text, default, subtext, icon, on_change, on_long_click, link_alias)
                    
                    val = PC.getInstance().getPluginSettingBoolean(plugin.getId(), key, default)
                    if subtext:
                        item = UItem.asButtonCheck(0, text, subtext, icon_res) if icon_res else UItem.asButtonCheck(0, text, subtext)
                    else:
                        item = UItem.asCheck(0, text, icon_res)
                    
                    if item:
                        item.setChecked(val)

            elif cls_name == 'EditText':
                if key:
                    hint = getattr(py_obj, 'hint', "")
                    default = getattr(py_obj, 'default', "")
                    multiline = getattr(py_obj, 'multiline', False)
                    max_len = int(getattr(py_obj, 'max_length', 0) or 0)
                    mask = getattr(py_obj, 'mask', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = EditTextSetting(key, hint, default, multiline, max_len, mask, on_change)
                    val = PC.getInstance().getPluginSettingString(plugin.getId(), key, default)

                    try:
                        EditTextCell = jclass("org.telegram.ui.Cells.EditTextCell")
                        Theme = jclass("org.telegram.ui.ActionBar.Theme")
                        TextWatcher = jclass("android.text.TextWatcher")
                        
                        cell = EditTextCell(AppLoader.applicationContext, hint, multiline, False, max_len, None)
                        cell.setBackgroundColor(Theme.getColor(Theme.key_windowBackgroundWhite))
                        cell.setText(val)
                        
                        class TextWatcherImpl(dynamic_proxy(TextWatcher)):
                            def __init__(self, cb, k, pid):
                                super().__init__()
                                self.cb = cb
                                self.key = k
                                self.pid = pid
                                self.old = ""
                                self.updating = False

                            def beforeTextChanged(self, s, start, count, after):
                                if self.updating: return
                                self.old = str(s)

                            def onTextChanged(self, s, start, before, count): pass

                            def afterTextChanged(self, s):
                                if self.updating: return
                                new_txt = str(s)
                                if new_txt == self.old: return
                                
                                PC.getInstance().setPluginSetting(self.pid, self.key, new_txt)
                                if self.cb:
                                    try: self.cb(new_txt)
                                    except: pass

                        watcher = TextWatcherImpl(on_change, key, plugin.getId())
                        cell.editText.addTextChangedListener(watcher)
                        item = UItem.asCustom(cell)
                            
                    except:
                        pass

            elif cls_name == 'Input':
                if key and text:
                    default = getattr(py_obj, 'default', "")
                    subtext = getattr(py_obj, 'subtext', None)
                    on_change = getattr(py_obj, 'on_change', None)
                    
                    setting = InputSetting(key, text, default, subtext, icon, on_change, on_long_click, link_alias)
                    val = PC.getInstance().getPluginSettingString(plugin.getId(), key, default)
                    
                    item = UItem.asButton(0, text, val)
                    if icon_res and item: item.iconResId = icon_res

            elif cls_name == 'Selector':
                if key and text:
                    items = getattr(py_obj, 'items', None)
                    if items:
                        default = getattr(py_obj, 'default', 0)
                        on_change = getattr(py_obj, 'on_change', None)
                        items_list = list(items)
                        
                        setting = SelectorSetting(key, text, default, items_list, icon, on_change, on_long_click, link_alias)
                        val = PC.getInstance().getPluginSettingInt(plugin.getId(), key, default)
                        
                        if val < 0 or val >= len(items): val = 0
                        item = UItem.asButton(0, text, items[val])
                        if icon_res and item: item.iconResId = icon_res

            elif cls_name == 'Text':
                if text:
                    accent = getattr(py_obj, 'accent', False) or False
                    red = getattr(py_obj, 'red', False) or False
                    on_click = getattr(py_obj, 'on_click', None)
                    create_sub = getattr(py_obj, 'create_sub_fragment', None)
                    
                    setting = TextSetting(text, icon, accent, red, on_click, create_sub, on_long_click, link_alias)
                    item = UItem.asButton(0, text)
                    if icon_res and item: item.iconResId = icon_res
                    if item:
                        if accent: item = item.accent()
                        if red: item = item.red()

            elif cls_name == 'Divider':
                txt = getattr(py_obj, 'text', "") or ""
                setting = DividerSetting(txt)
                item = UItem.asShadow(txt)

            if item and setting:
                item.settingItem = setting
                if key: item.object2 = key

            return item

        except Exception as e:
            return None

    def _collect_all_items(self, activity, plugin, items):
        all_items = []
        
        try:
            for i in range(items.size()):
                item = items.get(i)
                if item:
                    all_items.append(item)

            PC = jclass("com.exteragram.messenger.plugins.PluginsController")
            main_settings = PC.getInstance().getPluginSettingsList(plugin.getId())

            if main_settings:
                for idx in range(main_settings.size()):
                    setting = main_settings.get(idx)
                    if setting is None:
                        continue

                    if hasattr(setting, 'createSubFragmentCallback') and setting.createSubFragmentCallback:
                        sub_items = self._collect_sub_items(setting.createSubFragmentCallback, plugin)
                        all_items.extend(sub_items)

        except Exception as e:
            pass

        return all_items

    def _collect_sub_items(self, callback, plugin):
        sub_items = []

        try:
            py_result = callback()
            if not py_result:
                return sub_items

            for py_item in py_result:
                if py_item is None:
                    continue

                try:
                    item = self._create_uitem_from_py_object(py_item, plugin)
                    if item:
                        sub_items.append(item)

                    if hasattr(py_item, 'create_sub_fragment') and py_item.create_sub_fragment:
                        nested_items = self._collect_sub_items(py_item.create_sub_fragment, plugin)
                        sub_items.extend(nested_items)

                except Exception as e:
                    pass

        except Exception as e:
            pass

        return sub_items

class CustomBadgeHook:
    def __init__(self, plugin):
        self.plugin = plugin
        
    def after_hooked_method(self, param):
        try:
            tl_object = param.args[0]
            
            if self.plugin.TLRPC_User and isinstance(tl_object, self.plugin.TLRPC_User) and tl_object.id in self.plugin.custom_badges:
                custom_badge = self.plugin.custom_badges[tl_object.id]
                param.setResult(custom_badge)
                return custom_badge
                    
            if self.plugin.TLRPC_Chat and isinstance(tl_object, self.plugin.TLRPC_Chat) and tl_object.id in self.plugin.custom_badges:
                custom_badge = self.plugin.custom_badges[tl_object.id]
                param.setResult(custom_badge)
                return custom_badge
            
            return param.getResult()
        except:
            return param.getResult()


class CustomDeveloperHook:
    def __init__(self, plugin):
        self.plugin = plugin
        
    def after_hooked_method(self, param):
        try:
            if param.getResult():
                return True
            
            user = param.args[0]
            if user and hasattr(user, 'id') and user.id in self.plugin.custom_badges:
                param.setResult(True)
                return True
            
            return param.getResult()
        except:
            return param.getResult()


class CustomExteraHook:
    def __init__(self, plugin):
        self.plugin = plugin
        
    def after_hooked_method(self, param):
        try:
            if param.getResult():
                return True
            
            chat = param.args[0]
            if chat and hasattr(chat, 'id') and chat.id in self.plugin.custom_badges:
                param.setResult(True)
                return True
            
            return param.getResult()
        except:
            return param.getResult()


class QuantaDeeplinkHook:
    def __init__(self, plugin):
        self.plugin = plugin

    def before_hooked_method(self, param):
        try:
            if len(param.args) < 7:
                return
            intent = param.args[0]
            if not intent or intent.getAction() != "android.intent.action.VIEW":
                return
            data = intent.getData()
            if not data:
                return
            url = str(data)
            if url == "tg://quanta" or url == "tg:quanta":
                run_on_ui_thread(check_quanta_updates)
                param.setResult(None)
            elif url == "tg://restart":
                run_on_ui_thread(self._restart_app_direct)
                param.setResult(None)
            elif url == "tg://refresh":
                run_on_ui_thread(self._refresh_badges_direct)
                param.setResult(None)
        except Exception as e:
            self.plugin.log(f"Error in deeplink hook: {e}")

    def _restart_app_direct(self):
        restart_app()

    def _refresh_badges_direct(self):
        def refresh_callback():
            try:
                self.plugin.log("Force refreshing badges via tg://refresh")
                self.plugin.custom_badges.clear()
                badges_data = self.plugin._load_badges_from_config(force_refresh=True)
                if badges_data:
                    self.plugin._process_badges_from_data(badges_data)
                    self.plugin.log(f"Refreshed {len(self.plugin.custom_badges)} badges")
                    current_fragment = get_last_fragment()
                    BulletinHelper.show_success(get_string("refreshed_badges", "Refreshed {count} badges from QuantaConfig").format(count=len(self.plugin.custom_badges)), current_fragment)
                else:
                    self.plugin.log("No badges data received")
            except Exception as e:
                self.plugin.log(f"Error refreshing badges: {e}")
        
        import threading
        thread = threading.Thread(target=refresh_callback)
        thread.daemon = True
        thread.start()
    





class JsonCacheFile:
    cache_dir_name = os.path.join(os.path.dirname(os.path.realpath(__file__)), "cache")

    def __init__(self, filename: str, default: Any, read_on_init = True):
        self.filename = filename
        self.path = os.path.join(JsonCacheFile.cache_dir_name, filename)
        self.content = copy.copy(default)
        self.default = copy.copy(default)

        os.makedirs(JsonCacheFile.cache_dir_name, exist_ok=True)

        if read_on_init:
            self.read()

    def read(self) -> Any:
        try:
            with open(self.path) as file:
                self.content = json.load(file)
        except (json.JSONDecodeError, FileNotFoundError):
            self.wipe()
            return self.default
        else:
            return self.content

    def write(self):
        try:
            with open(self.path, "w") as file:
                json.dump(self.content, file)
        except PermissionError:
            quantahut_log("Permission error writing cache")
        except Exception as e:
            quantahut_log(f"Error writing cache: {str(e)}")

    def wipe(self):
        old_size = len(self.content)
        self.content = copy.copy(self.default)
        self.write()


class Callback1(dynamic_proxy(Utilities.Callback)):
    def __init__(self, fn: Callable[[Any], None]):
        super().__init__()
        self._fn = fn

    def run(self, arg):
        try:
            self._fn(arg)
        except Exception as e:
            quantahut_log(f"Callback error: {str(e)}")


class GitHubLocalization:
    def __init__(self):
        self.localization_cache = JsonCacheFile("quantahut_localization_cache", {})
        self.emoji_cache = JsonCacheFile("quantahut_emoji_cache", {})
        self.user_cache = JsonCacheFile("quantahut_user_cache", {})
        self.text_template_cache = JsonCacheFile("quantahut_text_template_cache", {})
    
    def _get_base_url(self):
        try:
            branch_index = setting_getter("localization_branch", DEFAULT_BRANCH) if setting_getter else DEFAULT_BRANCH
            branch = "main" if branch_index == 0 else "Beta"
            return f"https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/{branch}"
        except:
            return "https://raw.githubusercontent.com/luvztroy/UiTweaks/refs/heads/main"


    def get_localized_string(self, plugin_id: str, key: str, default: str = None) -> str:
        try:
            try:
                if plugin_id == "UiTweaks":
                    from base_plugin import PluginsController
                    from hook_utils import get_private_field
                    prefs = get_private_field(PluginsController.getInstance(), "preferences")
                    pref_lang = prefs.getString("plugin_setting_ui_tweaks_selected_language", None)
                else:
                    pref_lang = None
            except Exception:
                pref_lang = None
            if pref_lang:
                current_language = pref_lang
            else:
                from org.telegram.messenger import LocaleController
                current_language = LocaleController.getInstance().getCurrentLocaleInfo().getLangCode()
        except:
            current_language = "en"
        cache_key = f"{plugin_id}_{current_language}_{key}"
        
        cached_value = self.localization_cache.content.get(cache_key)
        if cached_value is not None:
            return cached_value
        
        return default or key
        
    def download_localization(self, plugin_id: str, language: str = "en", force_refresh: bool = False):
        try:
            import urllib.request
            import json
            base_url = self._get_base_url()
            with urllib.request.urlopen(f"{base_url}/{plugin_id}%20{language}.json") as response:
                data = json.loads(response.read().decode('utf-8'))
                
                cache_key = f"{plugin_id}_{language}"
                old_data = self.localization_cache.content.get(cache_key, {})
                
                if not force_refresh and old_data == data:
                    return "no_changes_detected"
                
                if old_data:
                    changes = []
                    for key in set(data.keys()) | set(old_data.keys()):
                        if key not in old_data:
                            changes.append(f"+{key}")
                        elif key not in data:
                            changes.append(f"-{key}")
                        elif data[key] != old_data[key]:
                            changes.append(f"~{key}")
                    
                    if changes:
                        quantahut_log(f"Changes: {', '.join(changes[:10])}{'...' if len(changes) > 10 else ''}")
                else:
                    quantahut_log(f"First time caching {len(data)} keys")
                
                keys_to_remove = []
                prefix = f"{plugin_id}_{language}_"
                for key in self.localization_cache.content.keys():
                    if key.startswith(prefix) and not key.endswith('_timestamp'):
                        keys_to_remove.append(key)
                
                for key in keys_to_remove:
                    del self.localization_cache.content[key]
                
                self.localization_cache.content[cache_key] = data
                for trans_key, trans_value in data.items():
                    self.localization_cache.content[f"{plugin_id}_{language}_{trans_key}"] = trans_value
                
                self.localization_cache.content[f"{plugin_id}_{language}_timestamp"] = time.time()
                self.localization_cache.write()
                return "updated"
                
        except Exception as e:
            quantahut_log(f"Error downloading localization: {str(e)}")
            raise

    def get_emoji_id(self, emoji_name: str) -> str:
        cached = self.emoji_cache.content.get(emoji_name)
        if cached:
            return cached
        return None

    def cache_emoji_id(self, emoji_name: str, emoji_id: str):
        self.emoji_cache.content[emoji_name] = emoji_id
        self.emoji_cache.write()

    def get_user_id(self, username: str) -> str:
        cached = self.user_cache.content.get(username)
        if cached:
            return cached
        return None

    def cache_user_id(self, username: str, user_id: str):
        self.user_cache.content[username] = user_id
        self.user_cache.write()

    def get_string_template(self, template_name: str) -> str:
        cached = self.text_template_cache.content.get(template_name)
        if cached:
            return cached
        return None

    def cache_text_template(self, template_name: str, template_content: str):
        self.text_template_cache.content[template_name] = template_content
        self.text_template_cache.write()

github_localization = GitHubLocalization()

def get_localized_string(plugin_id: str, key: str, default: str = None) -> str:
    return github_localization.get_localized_string(plugin_id, key, default)

def download_localization(plugin_id: str, language: str = "en", force_refresh: bool = False):
    github_localization.download_localization(plugin_id, language, force_refresh)

def restart_app(fragment=None):
    try:
        from android.os import Process
        from android.content import Intent
        if fragment is None:
            fragment = get_last_fragment()
        if not fragment:
            return
        context = fragment.getContext()
        intent = context.getPackageManager().getLaunchIntentForPackage(context.getPackageName())
        intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK | Intent.FLAG_ACTIVITY_CLEAR_TASK)
        context.startActivity(intent)
        Process.killProcess(Process.myPid())
    except Exception as e:
        quantahut_log(f"Error restarting app: {e}")

def show_restart_bulletin(message=None, button_text=None):
    try:
        from org.telegram.messenger import R as R_tg
        from ui.bulletin import BulletinHelper
        
        fragment = get_last_fragment()
        if not fragment:
                            return

        def _on_restart():
            restart_app(fragment)
        
        default_message = get_string("restart_to_apply_changes", "Restart app to apply changes")
        default_button = get_string("restart", "Restart")
        
        BulletinHelper.show_with_button(
            message or default_message,
            R_tg.raw.chats_infotip,
            button_text or default_button,
            _on_restart,
            fragment,
            10000
        )
        
    except Exception as e:
        pass

def check_quanta_updates():
    def check_callback():
        try:
            import time
            from base_plugin import PluginsController
            
            quantahut_instance = QuantaHut.instance if hasattr(QuantaHut, 'instance') else None
            
            if quantahut_instance:
                quantahut_instance._check_for_updates(show_on_load=True)
                
                timeout = 10
                start_time = time.time()
                while quantahut_instance.checking_update and (time.time() - start_time) < timeout:
                    time.sleep(0.1)
                
                if quantahut_instance.update_available:
                    return
            
            controller = PluginsController.getInstance()
            engine = controller.getPluginEngine("ui_tweaks")
            
            if engine and hasattr(engine, 'pluginInstances'):
                py_instance = engine.pluginInstances.get("ui_tweaks")
                if py_instance:
                    py_instance._check_for_updates(show_on_load=True)
                    time.sleep(2)
                    if not (hasattr(py_instance, 'update_available') and py_instance.update_available):
                        run_on_ui_thread(lambda: BulletinHelper.show_success(get_string("already_uptodate", "Already up to date")))
                        
        except Exception as e:
            quantahut_log(f"Error in quanta_update: {e}")
    
    import threading
    thread = threading.Thread(target=check_callback)
    thread.daemon = True
    thread.start()

def export_plugin_settings(plugin_id, plugin_name="Plugin", version="1.0.0"):
    try:
        from file_utils import get_cache_dir
        from com.exteragram.messenger.plugins import PluginsController
        from org.telegram.messenger import Utilities, ApplicationLoader
        from java.io import File, FileOutputStream, OutputStreamWriter
        from java.nio.charset import StandardCharsets
        from android.content import Intent
        from android.net import Uri
        from org.telegram.ui import LaunchActivity
        from java.text import SimpleDateFormat
        from java.util import Date
        
        controller = PluginsController.getInstance()
        all_settings = {}
        
        if controller.plugins.containsKey(plugin_id):
            plugin = controller.plugins.get(plugin_id)
            engine = controller.getPluginEngine(plugin_id)
            if engine:
                settings = engine.getAllPluginSettings(plugin_id)
                if settings and not settings.isEmpty():
                    plugin_settings = {}
                    setting_keys = settings.keySet().toArray()
                    for key in setting_keys:
                        value = settings.get(key)
                        if value is not None:
                            plugin_settings[str(key)] = _convert_to_serializable(value)
                    
                    if plugin_settings:
                        all_settings[plugin_id] = {
                            "name": plugin.getName(),
                            "version": plugin.getVersion(),
                            "enabled": plugin.isEnabled(),
                            "settings": plugin_settings
                        }
        
        if not all_settings:
            return
        
        formatter = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        backup_data = {
            "plugin": plugin_name,
            "version": version,
            "exported_at": formatter.format(Date()),
            "settings": all_settings.get(plugin_id, {}).get("settings", {})
        }
        
        cache_dir = get_cache_dir()
        random_str = Utilities.generateRandomString(4)
        backup_filename = f"backup-{random_str}.quanta"
        backup_file_path = os.path.join(cache_dir, backup_filename)
        
        backup_file = File(backup_file_path)
        if backup_file.exists():
            backup_file.delete()
        
        stream = FileOutputStream(backup_file)
        writer = OutputStreamWriter(stream, StandardCharsets.UTF_8)
        writer.write(json.dumps(backup_data, indent=2))
        writer.flush()
        writer.close()
        
        def open_telegram_share():
            try:
                context = ApplicationLoader.applicationContext
                file_uri = Uri.fromFile(backup_file)
                
                intent = Intent(context, LaunchActivity)
                intent.setAction(Intent.ACTION_SEND)
                intent.setType("application/octet-stream")
                intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                
                context.startActivity(intent)
            except Exception:
                pass
        
        run_on_ui_thread(open_telegram_share)
        
    except Exception as e:
        quantahut_log(f"Error exporting plugin settings: {e}")

def _has_sensitive_keys(all_settings):
    sensitive_keywords = ['api', 'key', 'token', 'secret', 'password', 'auth', 'credential']
    for plugin_settings in all_settings.values():
        for key in plugin_settings.get("settings", {}).keys():
            if any(kw in str(key).lower() for kw in sensitive_keywords):
                return True
    return False

def export_all_plugin_settings(include_sensitive=None):
    try:
        from file_utils import get_cache_dir
        from com.exteragram.messenger.plugins import PluginsController
        from org.telegram.messenger import Utilities, ApplicationLoader
        from java.io import File, FileOutputStream, OutputStreamWriter
        from java.nio.charset import StandardCharsets
        from android.content import Intent
        from android.net import Uri
        from org.telegram.ui import LaunchActivity
        from java.text import SimpleDateFormat
        from java.util import Date
        
        controller = PluginsController.getInstance()
        all_settings = {}
        exported_count = 0
        
        plugin_ids = controller.plugins.keySet().toArray()
        for plugin_id in plugin_ids:
            plugin = controller.plugins.get(plugin_id)
            engine = controller.getPluginEngine(plugin_id)
            if engine:
                settings = engine.getAllPluginSettings(plugin_id)
                if settings and not settings.isEmpty():
                    plugin_settings = {}
                    setting_keys = settings.keySet().toArray()
                    sensitive_keywords = ['api', 'key', 'token', 'secret', 'password', 'auth', 'credential']
                    for key in setting_keys:
                        value = settings.get(key)
                        if value is not None:
                            if include_sensitive == False and any(kw in str(key).lower() for kw in sensitive_keywords):
                                continue
                            plugin_settings[str(key)] = _convert_to_serializable(value)
                    
                    if plugin_settings:
                        all_settings[str(plugin_id)] = {
                            "name": plugin.getName(),
                            "version": plugin.getVersion(),
                            "enabled": plugin.isEnabled(),
                            "settings": plugin_settings
                        }
                        exported_count += 1
        
        if include_sensitive is None and _has_sensitive_keys(all_settings):
            from org.telegram.ui.ActionBar import AlertDialog
            from org.telegram.ui.Cells import CheckBoxCell
            fragment = get_last_fragment()
            if fragment:
                context = fragment.getParentActivity()
                builder = AlertDialog.Builder(context)
                builder.setTitle(get_string("export_warning_title", "Export Settings"))
                builder.setMessage(get_string("export_warning_message", "Some plugins contain sensitive data.Would you like to Include them?"))
                
                checkbox_cell = CheckBoxCell(context, 1)
                checkbox_cell.setBackgroundDrawable(Theme.getSelectorDrawable(False))
                checkbox_cell.setText(get_string("include_api_keys", "Include sensitive data"), "", False, False)
                
                OnClickInterface = find_class("android.view.View$OnClickListener")
                OnClick = dynamic_proxy(OnClickInterface)
                class CheckBoxClick(OnClick):
                    def onClick(self, v):
                        checkbox_cell.setChecked(not checkbox_cell.isChecked(), True)
                checkbox_cell.setOnClickListener(CheckBoxClick())
                
                frame = FrameLayout(context)
                frame.addView(checkbox_cell, LayoutHelper.createFrame(-1, 48, Gravity.BOTTOM | Gravity.LEFT, 0, 0, 0, 0))
                builder.setView(frame)
                
                OnButtonClickInterface = find_class("org.telegram.ui.ActionBar.AlertDialog$OnButtonClickListener")
                OnButtonClick = dynamic_proxy(OnButtonClickInterface)
                class ExportClick(OnButtonClick):
                    def onClick(self, dialog, which):
                        export_all_plugin_settings(include_sensitive=checkbox_cell.isChecked())
                
                builder.setPositiveButton(get_string("export", "Export"), ExportClick())
                builder.setNegativeButton(get_string("cancel", "Cancel"), None)
                run_on_ui_thread(lambda: builder.show())
            return
        
        formatter = SimpleDateFormat("yyyy-MM-dd HH:mm:ss")
        backup_data = {
            "exported_at": formatter.format(Date()),
            "plugin_count": exported_count,
            "plugins": all_settings
        }
        
        cache_dir = get_cache_dir()
        random_str = Utilities.generateRandomString(4)
        backup_filename = f"Plugin Settings-{random_str}.backup"
        backup_file_path = os.path.join(cache_dir, backup_filename)
        
        backup_file = File(backup_file_path)
        if backup_file.exists():
            backup_file.delete()
        
        stream = FileOutputStream(backup_file)
        writer = OutputStreamWriter(stream, StandardCharsets.UTF_8)
        writer.write(json.dumps(backup_data, indent=2))
        writer.flush()
        writer.close()
        
        def open_telegram_share():
            try:
                context = ApplicationLoader.applicationContext
                file_uri = Uri.fromFile(backup_file)
                
                intent = Intent(context, LaunchActivity)
                intent.setAction(Intent.ACTION_SEND)
                intent.setType("application/octet-stream")
                intent.putExtra(Intent.EXTRA_STREAM, file_uri)
                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)
                intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION)
                
                context.startActivity(intent)
            except Exception:
                pass
        
        run_on_ui_thread(open_telegram_share)
        
    except Exception as e:
        quantahut_log(f"Error exporting all plugin settings: {e}")

def _convert_to_serializable(value):
    if value is None:
        return None
    
    value_type = type(value).__name__
    
    if value_type in ['bool', 'int', 'float', 'str']:
        return value
    elif value_type == 'Boolean':
        return bool(value)
    elif value_type in ['Integer', 'Long']:
        return int(value)
    elif value_type == 'Float':
        return float(value)
    elif value_type == 'String':
        return str(value)
    else:
        try:
            return str(value)
        except:
            return None

def perform_haptic(host=None):
    try:
        from android.view import HapticFeedbackConstants
        root = None
        if host:
            get_pa = getattr(host, 'getParentActivity', None)
            if callable(get_pa):
                act = get_pa()
                if act:
                    root = act.getWindow().getDecorView()
            if root is None and hasattr(host, 'getWindow'):
                root = host.getWindow().getDecorView()
        if root is None:
            cf = get_last_fragment()
            if cf:
                act = cf.getParentActivity()
                if act:
                    root = act.getWindow().getDecorView()
        if root:
            flags = HapticFeedbackConstants.FLAG_IGNORE_VIEW_SETTING | HapticFeedbackConstants.FLAG_IGNORE_GLOBAL_SETTING
            root.performHapticFeedback(HapticFeedbackConstants.KEYBOARD_TAP, flags)
    except:
        pass

__all__ = ("get_localized_string", "download_localization", "JsonCacheFile", "utilities", "hut", "showupdatebottomsheet", "show_restart_bulletin", "MultiSelectorBottomSheet", "export_plugin_settings", "export_all_plugin_settings", "perform_haptic")

class UpdateBottomSheet:
    def __init__(self, context, activity, fragment, available_languages=None, localization_cache=None):
        self.context = context
        self.activity = activity
        self.fragment = fragment
        self.bottom_sheet = None
        self.download_button = None
        self.language_selector_layout = None
        self.language_selector_inner_layout = None
        self.language_avatar_view = None
        self.language_selector_icon_view = None
        self.current_language = "en"
        self.available_languages = available_languages or []
        self.selected_github_url = None
        self.localization_cache = localization_cache
        self.status_text_view = None
        
    def _get_selected_branch(self):
        try:
            branch_index = setting_getter("update_branch", DEFAULT_BRANCH) if setting_getter else DEFAULT_BRANCH
            return "main" if branch_index == 0 else "Beta"
        except:
            return "main"
    
    def log(self, message: str):
        if self.get_setting("show_logs", DEFAULT_SHOW_LOGS):
            log(f"[QuantaHut] {message}")

    def update_status(self, message):
        try:
            if self.status_text_view:
                self.status_text_view.setText(message)
                self.status_text_view.setVisibility(0) 
        except Exception as e:
            pass
    
    def _perform_haptic(self):
        try:
            perform_haptic(self.activity)
        except Exception as e:
            pass
   


    def _load_sticker_avatar(self, avatar_image_view, sticker_pack_name: str, sticker_index_to_use: int):
        try:
            try:
                current_account = self.fragment.getCurrentAccount()
            except Exception:
                current_account = 0

            media_controller = MediaDataController.getInstance(current_account)
            if media_controller is None:
                quantahut_log("MediaDataController is None, cannot load sticker")
                return

            sticker_set = media_controller.getStickerSetByName(sticker_pack_name)
            if sticker_set and sticker_set.documents and sticker_set.documents.size() > sticker_index_to_use:
                sticker_document = sticker_set.documents.get(sticker_index_to_use)
                image_location = ImageLocation.getForDocument(sticker_document)
                avatar_image_view.setImage(image_location, "90_90", None, 0, sticker_document)
                quantahut_log(f"Sticker loaded from cache: {sticker_pack_name} (account {current_account})")
                return
            quantahut_log(f"Sticker cache miss: {sticker_pack_name}, requesting set; will update on response")

            try:
                from org.telegram.tgnet import TLRPC
                input_set = TLRPC.TL_inputStickerSetShortName()
                input_set.short_name = sticker_pack_name

                def _on_set_response(result):
                    try:
                        if result and result.documents and result.documents.size() > sticker_index_to_use:
                            doc = result.documents.get(sticker_index_to_use)
                            img_loc = ImageLocation.getForDocument(doc)
                            run_on_ui_thread(lambda: avatar_image_view.setImage(img_loc, "90_90", None, 0, doc))
                            quantahut_log(f"Sticker loaded after fetch: {sticker_pack_name}")
                    except Exception as _e_inner:
                        quantahut_log(f"Error applying fetched sticker: {_e_inner}")

                media_controller.getStickerSet(input_set, None, False, Callback1(_on_set_response))
            except Exception as _e_fetch:
                quantahut_log(f"Error requesting sticker set '{sticker_pack_name}': {_e_fetch}")
        except Exception as e:
            quantahut_log(f"Error in _load_sticker_avatar: {e}")

    def create_bottom_sheet(self, title, subtitle=None, description=None, github_url=None, plugin_name=None, sticker_pack=None, sticker_index=None, raw_resource=None, button_text="Download", button2_text=None, bottom_text=None, show_close_button=True, show_user_avatar=False, sticker_circle=True, sticker_size=90, description_centered=False, on_button_click=None, on_button2_click=None, on_sticker_long_click=None):
        from org.telegram.ui.ActionBar import BottomSheet
        from org.telegram.ui.Components import LayoutHelper
        from org.telegram.messenger import AndroidUtilities
        from android.widget import LinearLayout, TextView, ImageView, FrameLayout
        from android.view import Gravity
        from android.graphics import Typeface
        from android.util import TypedValue
        from androidx.core.widget import NestedScrollView
        from org.telegram.ui.ActionBar import Theme
        
        
        try:
            from org.telegram.messenger import LocaleController
            self.current_language = LocaleController.getInstance().getCurrentLocaleInfo().getLangCode()
        except:
            self.current_language = "en"
        
        self.bottom_sheet = BottomSheet(self.context, False, self.fragment.getResourceProvider())
        self.bottom_sheet.setApplyBottomPadding(False)
        self.bottom_sheet.setApplyTopPadding(False)
        self.bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
        
        linear_layout = LinearLayout(self.context)
        linear_layout.setOrientation(LinearLayout.VERTICAL)
        linear_layout.setClickable(True)
        
        frame_layout = FrameLayout(self.context)
        frame_layout.addView(linear_layout)
        
        scroll_view = NestedScrollView(self.context)
        scroll_view.addView(frame_layout)
        self.bottom_sheet.setCustomView(scroll_view)
        
        OnClickInterface = find_class("android.view.View$OnClickListener")
        OnClick = dynamic_proxy(OnClickInterface)
        
        if show_close_button:
            close_view = ImageView(self.context)
            close_view.setBackground(Theme.createSelectorDrawable(Theme.getColor(Theme.key_listSelector)))
            close_view.setColorFilter(Theme.getColor(Theme.key_sheet_other))
            close_view.setImageResource(R_tg.drawable.ic_layer_close)
            class CloseClickImpl(OnClick):
                def __init__(self, bottom_sheet):
                    super().__init__()
                    self.bottom_sheet = bottom_sheet
                def onClick(self, v):
                    self.bottom_sheet.dismiss()
            close_view.setOnClickListener(CloseClickImpl(self.bottom_sheet))
            close_padding = AndroidUtilities.dp(8)
            close_view.setPadding(close_padding, close_padding, close_padding, close_padding)
            frame_layout.addView(close_view, LayoutHelper.createFrame(36, 36, Gravity.TOP | Gravity.END, 6, 8, 8, 0))
        
        

        from org.telegram.ui.Components import BackupImageView
        avatar_image_view = BackupImageView(self.context)
        if sticker_circle:
            avatar_image_view.setRoundRadius(AndroidUtilities.dp(45))
        else:
            avatar_image_view.setRoundRadius(AndroidUtilities.dp(0))
        
        if on_sticker_long_click:
            OnLongClickInterface = find_class("android.view.View$OnLongClickListener")
            OnLongClick = dynamic_proxy(OnLongClickInterface)
            class StickerLongClickImpl(OnLongClick):
                def __init__(self, callback, bottom_sheet_instance):
                    super().__init__()
                    self.callback = callback
                    self.bottom_sheet_instance = bottom_sheet_instance
                def onLongClick(self, v):
                    try:
                        self.bottom_sheet_instance._perform_haptic()
                        if callable(self.callback):
                            self.callback(self.bottom_sheet_instance)
                        return True
                    except Exception as e:
                        return False
            avatar_image_view.setOnLongClickListener(StickerLongClickImpl(on_sticker_long_click, self))
        
        linear_layout.addView(avatar_image_view, LayoutHelper.createLinear(sticker_size, sticker_size, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 17, 20, 17, 0))
        
        try:
            if show_user_avatar:
                from org.telegram.ui.Components import AvatarDrawable
                from org.telegram.messenger import UserConfig
                
                current_user = UserConfig.getInstance(0).getCurrentUser()
                avatar_drawable = AvatarDrawable()
                avatar_drawable.setInfo(current_user)
                avatar_image_view.setForUserOrChat(current_user, avatar_drawable)
                quantahut_log("User avatar loaded successfully")
            elif raw_resource:
                from org.telegram.ui.Components import RLottieImageView
                lottie_view = RLottieImageView(self.context)
                lottie_view.setAnimation(raw_resource, 144, 144)
                lottie_view.playAnimation()
                linear_layout.removeView(avatar_image_view)
                linear_layout.addView(lottie_view, LayoutHelper.createLinear(144, 144, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 0, 16, 0, 0))
                quantahut_log(f"Raw resource loaded: {raw_resource}")
            elif sticker_pack:
                sticker_pack_name = sticker_pack
                sticker_index_to_use = sticker_index if sticker_index is not None else 0
                self._load_sticker_avatar(avatar_image_view, sticker_pack_name, sticker_index_to_use)
            else:
                quantahut_log("No sticker pack or raw resource specified, avatar will remain empty")
        except Exception as e:
            quantahut_log(f"Error setting avatar: {str(e)}")
        
        title_text_view = TextView(self.context)
        title_text_view.setTypeface(AndroidUtilities.getTypeface("fonts/rmedium.ttf"))
        title_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 20)
        title_text_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteBlackText))
        title_text_view.setText(title)
        title_text_view.setGravity(Gravity.CENTER_HORIZONTAL)
        linear_layout.addView(title_text_view, LayoutHelper.createLinear(-1, -2, 0, 40, 20, 40, 0))
        
        if subtitle:
            subtitle_text_view = TextView(self.context)
            subtitle_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            subtitle_text_view.setTextColor(Theme.getColor(Theme.key_windowBackgroundWhiteGrayText))
            subtitle_text_view.setText(subtitle)
            subtitle_text_view.setGravity(Gravity.CENTER_HORIZONTAL)
            linear_layout.addView(subtitle_text_view, LayoutHelper.createLinear(-1, -2, 0, 21, 15, 21, 8))
        
        if description:
            from org.telegram.ui.Components.spoilers import SpoilersTextView
            from android.text import SpannableStringBuilder
            from org.telegram.messenger import MessageObject
            
            description_text_view = SpoilersTextView(self.context)
            if description_centered:
                description_text_view.setGravity(Gravity.CENTER_HORIZONTAL | Gravity.TOP)
            else:
                description_text_view.setGravity(Gravity.LEFT | Gravity.TOP)
            
            try:
                formatted_description = description.replace("\\n", "\n")
                builder = SpannableStringBuilder(formatted_description)
                from org.telegram.messenger import AndroidUtilities as AU
                formatted_text = AU.replaceTags(formatted_description)
                description_text_view.setText(formatted_text)
            except Exception as e:
                description_text_view.setText(description.replace("\\n", "\n"))
            
            description_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            description_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 15)
            description_text_view.setMovementMethod(AU.LinkMovementMethodMy())
            description_text_view.setLinkTextColor(Theme.getColor(Theme.key_dialogTextLink))
            linear_layout.addView(description_text_view, LayoutHelper.createLinear(-1, -2, Gravity.LEFT | Gravity.TOP, 23, 15, 23, 20))
        
        self.download_button = TextView(self.context)
        self.download_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(8), 
            Theme.getColor(Theme.key_featuredStickers_addButton), 
            Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        ))
        self.download_button.setGravity(Gravity.CENTER)
        self.download_button.setSingleLine(True)
        current_lang_display = self.current_language.upper()
        try:
            for lang in self.available_languages:
                if lang['code'] == self.current_language:
                    current_lang_display = lang['display_name']
                    break
        except:
            pass
        
        initial_button_text = f"{button_text} {current_lang_display}" if github_url else button_text
        self.download_button.setText(initial_button_text)
        self.download_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        self.download_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        self.download_button.setTypeface(AndroidUtilities.bold())
        class DownloadClickImpl(OnClick):
            def __init__(self, bottom_sheet_instance, custom_callback=None):
                super().__init__()
                self.bottom_sheet_instance = bottom_sheet_instance
                self.custom_callback = custom_callback
            def onClick(self, v):
                if self.custom_callback:
                    self.custom_callback()
                    if self.bottom_sheet_instance.bottom_sheet:
                        self.bottom_sheet_instance.bottom_sheet.dismiss()
                else:
                    self.bottom_sheet_instance._on_download_click(github_url, plugin_name)
        self.download_button.setOnClickListener(DownloadClickImpl(self, on_button_click))
        linear_layout.addView(self.download_button, LayoutHelper.createLinear(-1, 48, Gravity.START, 14, 0, 14, 14))
        
        if button2_text and on_button2_click:
            from org.telegram.ui.Stories.recorder import ButtonWithCounterView
            button2 = ButtonWithCounterView(self.context, False, self.fragment.getResourceProvider())
            button2.setText(button2_text, False)
            class Button2ClickImpl(OnClick):
                def __init__(self, bottom_sheet_instance, callback):
                    super().__init__()
                    self.bottom_sheet_instance = bottom_sheet_instance
                    self.callback = callback
                def onClick(self, v):
                    if self.callback:
                        self.callback()
                    if self.bottom_sheet_instance.bottom_sheet:
                        self.bottom_sheet_instance.bottom_sheet.dismiss()
            button2.setOnClickListener(Button2ClickImpl(self, on_button2_click))
            linear_layout.addView(button2, LayoutHelper.createLinear(-1, 48, Gravity.START, 14, 0, 14, 14))
        
        if bottom_text:
            disclaimer_text_view = TextView(self.context)
            disclaimer_text_view.setGravity(Gravity.CENTER)
            disclaimer_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            disclaimer_text_view.setText(bottom_text)
            disclaimer_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
            linear_layout.addView(disclaimer_text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 24, 17, 24, 15))
        
        self.status_text_view = TextView(self.context)
        self.status_text_view.setGravity(Gravity.CENTER)
        self.status_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 12)
        self.status_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
        self.status_text_view.setVisibility(8)
        linear_layout.addView(self.status_text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 10))
    
    def _on_download_click(self, github_url, plugin_name):
        quantahut_log("Download button clicked!")
        
        download_url = self.selected_github_url or github_url
        
        if download_url is None:
            quantahut_log("Localization not available, storing user choice to continue in English")
            self._store_continue_english_choice(plugin_name)
            self.bottom_sheet.dismiss()
            return
        
        self._show_loading_state()
        self._download_and_cache_plugin(download_url, plugin_name)
    
    def _store_continue_english_choice(self, plugin_name):
        try:
            from java.util import Locale
            current_language = Locale.getDefault().getLanguage()
            
            if plugin_name == "UiTweaks_Localization":
                continue_english_key = f"continue_english_{current_language}"
                from base_plugin import PluginsController
                prefs = get_private_field(PluginsController.getInstance(), "preferences")
                prefs.edit().putBoolean(f"plugin_setting_ui_tweaks_{continue_english_key}", True).apply()
                quantahut_log(f"Stored continue in English choice for {current_language}")
        except Exception as e:
            quantahut_log(f"Error storing continue English choice: {e}")
    
    def _show_loading_state(self):
        if self.download_button:
            self.download_button.setText("Downloading...")
            self.download_button.setEnabled(False)
    
    def _download_and_cache_plugin(self, github_url, plugin_name):
        def download_callback():
            try:
                quantahut_log(f"Downloading localization from: {github_url}")
                
                language = self.current_language
                
                result = github_localization.download_localization("UiTweaks", language)
                
                if result == "no_update_needed":
                    quantahut_log(f"No update needed for language: {language}")
                    run_on_ui_thread(lambda: self._show_no_update_state())
                elif result == "no_changes_detected":
                    quantahut_log(f"No changes detected for language: {language}")
                    run_on_ui_thread(lambda: self._show_no_changes_state())
                elif result == "updated":
                    quantahut_log(f"Localization updated for language: {language}")
                    run_on_ui_thread(lambda: self._show_success_state())
                else:
                    quantahut_log(f"Localization cached for language: {language}")
                    run_on_ui_thread(lambda: self._show_success_state())
                
            except Exception as e:
                error_message = str(e)
                quantahut_log(f"Error downloading localization: {error_message}")
                run_on_ui_thread(lambda: self._show_error_state(f"Download failed: {error_message}"))
        
        import threading
        thread = threading.Thread(target=download_callback)
        thread.daemon = True
        thread.start()
    
    def _show_success_state(self):
        if self.download_button:
            self.download_button.setText("Cached!")
            self.download_button.setEnabled(False)
        
        def dismiss_delayed():
            run_on_ui_thread(lambda: self.bottom_sheet.dismiss())
            run_on_ui_thread(lambda: show_restart_bulletin(
                message=get_string("restart_to_apply_localization", "Restart app to apply localization changes"),
                button_text=get_string("restart", "Restart")
            ))
        import threading
        timer = threading.Timer(2.0, dismiss_delayed)
        timer.start()
    
    def _show_error_state(self, error_message):
        if self.download_button:
            self.download_button.setText("Retry")
            self.download_button.setEnabled(True)
        quantahut_log(f"Error: {error_message}")
    
    def _show_no_update_state(self):
        if self.download_button:
            self.download_button.setText("No Update Needed")
            self.download_button.setEnabled(False)
        
        def dismiss_delayed():
            run_on_ui_thread(lambda: self.bottom_sheet.dismiss())
        
        import threading
        timer = threading.Timer(2.0, dismiss_delayed)
        timer.start()
    
    def _show_no_changes_state(self):
        if self.download_button:
            self.download_button.setText("Already Up to Date")
            self.download_button.setEnabled(False)
        
        def dismiss_delayed():
            run_on_ui_thread(lambda: self.bottom_sheet.dismiss())
        
        import threading
        timer = threading.Timer(2.0, dismiss_delayed)
        timer.start()
    
    def show(self):
        if self.bottom_sheet:
            self.bottom_sheet.show()



def showmultiselector(items, title, subtitle, setting_keys, plugin_instance, max_selection=None, on_selection_change=None, item_subtexts=None, default=None, action_text=None, show_count=True, on_action_click=None, show_select_all=False):
    try:
        fragment = get_last_fragment()
        if not fragment:
            return
        
        context = fragment.getContext()
        
        if max_selection is None:
            max_selection = len(items)
        
        if not hasattr(plugin_instance, '_multi_selector_settings'):
            plugin_instance._multi_selector_settings = set()
        plugin_instance._multi_selector_settings.update(setting_keys)
        
        from org.telegram.ui.ActionBar import BottomSheet
        from org.telegram.ui.Components import LayoutHelper
        from org.telegram.messenger import AndroidUtilities
        from android.widget import LinearLayout, TextView, FrameLayout
        from android.view import Gravity
        from android.util import TypedValue
        from androidx.core.widget import NestedScrollView
        from org.telegram.ui.ActionBar import Theme
        from org.telegram.ui.Components import CheckBox2
        from android.widget import ImageView
        from org.telegram.ui.ActionBar import SimpleTextView
        
        bottom_sheet = BottomSheet(context, False, fragment.getResourceProvider())
        bottom_sheet.setApplyBottomPadding(False)
        bottom_sheet.setApplyTopPadding(False)
        bottom_sheet.fixNavigationBar(Theme.getColor(Theme.key_windowBackgroundWhite))
        
        linear_layout = LinearLayout(context)
        linear_layout.setOrientation(LinearLayout.VERTICAL)
        linear_layout.setClickable(True)
        
        frame_layout = FrameLayout(context)
        frame_layout.addView(linear_layout)
        
        scroll_view = NestedScrollView(context)
        scroll_view.addView(frame_layout)
        bottom_sheet.setCustomView(scroll_view)
        
        title_text_view = SimpleTextView(context)
        title_text_view.setTypeface(AndroidUtilities.bold())
        title_text_view.setTextSize(20)
        title_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
        title_text_view.setText(title)
        title_text_view.setGravity(Gravity.CENTER)
        linear_layout.addView(title_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 20, 10, 0))
        
        subtitle_text_view = TextView(context)
        subtitle_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
        subtitle_text_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
        subtitle_text_view.setSingleLine(True)
        subtitle_text_view.setText(subtitle)
        subtitle_text_view.setGravity(Gravity.CENTER)
        linear_layout.addView(subtitle_text_view, LayoutHelper.createLinear(-2, -2, Gravity.TOP | Gravity.CENTER_HORIZONTAL, 10, 0, 10, 0))
        
        selected_items = set()
        checkboxes = {}
        select_all_button = [None]
        
        def update_action_button_text():
            if action_text:
                count = len(selected_items)
                if show_count:
                    action_button.setText(f"{action_text} ({count})")
                else:
                    action_button.setText(action_text)
            action_button.setEnabled(True)
        
        def on_selection_changed(selected_indices):
            for i, key in enumerate(setting_keys):
                plugin_instance.set_setting(key, i in selected_indices)
            
            if hasattr(plugin_instance, 'setup_hooks'):
                plugin_instance.setup_hooks()
            
            if on_selection_change:
                selected_keys = [setting_keys[i] for i in selected_indices]
                should_restart = on_selection_change(selected_keys)
                if should_restart:
                    action_button.setText(get_string("restart_to_apply_changes", "Restart to apply changes"))
                else:
                    update_action_button_text()
        
        OnClickInterface = find_class("android.view.View$OnClickListener")
        OnClick = dynamic_proxy(OnClickInterface)
        
        if show_select_all:
            select_all_text_view = TextView(context)
            select_all_text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
            select_all_text_view.setTextColor(Theme.getColor(Theme.key_featuredStickers_addButton))
            select_all_text_view.setText(get_string("select_all", "Select All"))
            select_all_text_view.setGravity(Gravity.CENTER_VERTICAL | Gravity.LEFT)
            select_all_text_view.setPadding(AndroidUtilities.dp(24), AndroidUtilities.dp(10), AndroidUtilities.dp(10), AndroidUtilities.dp(10))
            select_all_button[0] = select_all_text_view
            
            class SelectAllClickImpl(OnClick):
                def onClick(self, v):
                    if len(selected_items) == len(items):
                        selected_items.clear()
                        for checkbox in checkboxes.values():
                            checkbox.setChecked(False, True)
                        select_all_text_view.setText(get_string("select_all", "Select All"))
                    else:
                        selected_items.clear()
                        for i in range(len(items)):
                            selected_items.add(i)
                            checkboxes[i].setChecked(True, True)
                        select_all_text_view.setText(get_string("deselect_all", "Deselect All"))
                    
                    update_action_button_text()
                    
                    if on_selection_changed:
                        on_selection_changed(list(selected_items))
            
            select_all_text_view.setOnClickListener(SelectAllClickImpl())
            linear_layout.addView(select_all_text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP | Gravity.LEFT, 0, 10, 0, 10))
        
        for i, item_text in enumerate(items):
            item_container = FrameLayout(context)
            item_container.setBackground(None)
            
            checkbox = CheckBox2(context, 21, fragment.getResourceProvider())
            checkbox.setColor(Theme.key_dialogRoundCheckBox, Theme.key_checkboxDisabled, Theme.key_dialogRoundCheckBoxCheck)
            checkbox.setDrawUnchecked(True)
            checkbox.setDrawBackgroundAsArc(10)
            checkbox.setChecked(False, False)
            checkbox.setVisibility(1)
            
            text_container = LinearLayout(context)
            text_container.setOrientation(LinearLayout.VERTICAL)
            text_container.setGravity(Gravity.CENTER_VERTICAL)
            
            text_view = TextView(context)
            text_view.setText(item_text)
            text_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 16)
            text_view.setTextColor(Theme.getColor(Theme.key_dialogTextBlack))
            text_view.setGravity(Gravity.CENTER_VERTICAL)
            text_container.addView(text_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 0))
            
            if item_subtexts and i < len(item_subtexts) and item_subtexts[i]:
                subtext_view = TextView(context)
                subtext_view.setText(item_subtexts[i])
                subtext_view.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 13)
                subtext_view.setTextColor(Theme.getColor(Theme.key_dialogTextGray3))
                subtext_view.setGravity(Gravity.CENTER_VERTICAL)
                text_container.addView(subtext_view, LayoutHelper.createLinear(-1, -2, Gravity.TOP, 0, 0, 0, 0))
            
            item_container.addView(checkbox, LayoutHelper.createFrame(24, 24, Gravity.CENTER_VERTICAL | Gravity.LEFT, 16, 0, 0, 0))
            item_container.addView(text_container, LayoutHelper.createFrame(-1, -1, Gravity.CENTER_VERTICAL | Gravity.LEFT, 56, 0, 16, 0))
            
            checkboxes[i] = checkbox
            
            class ItemClickImpl(OnClick):
                def __init__(self, item_index):
                    super().__init__()
                    self.item_index = item_index
                def onClick(self, v):
                    checkbox = checkboxes.get(self.item_index)
                    if checkbox:
                        if self.item_index in selected_items:
                            selected_items.remove(self.item_index)
                            checkbox.setChecked(False, True)
                        else:
                            if len(selected_items) >= max_selection:
                                from org.telegram.ui.Components import BulletinFactory
                                BulletinFactory.of(bottom_sheet.container, fragment.getResourceProvider()).createSimpleBulletin(
                                    R_tg.raw.chats_infotip, 
                                    f"Maximum {max_selection} items allowed"
                                ).show(True)
                                return
                            
                            selected_items.add(self.item_index)
                            checkbox.setChecked(True, True)
                        
                        update_action_button_text()
                        
                        if show_select_all and select_all_button[0]:
                            if len(selected_items) == len(items):
                                select_all_button[0].setText(get_string("deselect_all", "Deselect All"))
                            else:
                                select_all_button[0].setText(get_string("select_all", "Select All"))
                        
                        if on_selection_changed:
                            on_selection_changed(list(selected_items))
            
            item_container.setOnClickListener(ItemClickImpl(i))
            item_height = 72 if (item_subtexts and i < len(item_subtexts) and item_subtexts[i]) else 56
            linear_layout.addView(item_container, LayoutHelper.createLinear(-1, item_height, Gravity.TOP, 0, 0, 0, 0))
        
        action_button = TextView(context)
        action_button.setBackground(Theme.createSimpleSelectorRoundRectDrawable(
            AndroidUtilities.dp(8), 
            Theme.getColor(Theme.key_featuredStickers_addButton), 
            Theme.getColor(Theme.key_featuredStickers_addButtonPressed)
        ))
        action_button.setGravity(Gravity.CENTER)
        action_button.setSingleLine(True)
        update_action_button_text()
        action_button.setTextColor(Theme.getColor(Theme.key_featuredStickers_buttonText))
        action_button.setTextSize(TypedValue.COMPLEX_UNIT_DIP, 14)
        action_button.setTypeface(AndroidUtilities.bold())
        action_button.setEnabled(True)
        
        class ActionClickImpl(OnClick):
            def onClick(self, v):
                if on_action_click:
                    selected_keys = [setting_keys[i] for i in selected_items]
                    on_action_click(selected_keys)
                    from android_utils import run_on_ui_thread
                    run_on_ui_thread(lambda: bottom_sheet.dismiss())
                    return
                
                for i, key in enumerate(setting_keys):
                    plugin_instance.set_setting(key, i in selected_items)
                
                if hasattr(plugin_instance, 'setup_hooks'):
                    plugin_instance.setup_hooks()
                
                if on_selection_change:
                    selected_keys = [setting_keys[i] for i in selected_items]
                    should_restart = on_selection_change(selected_keys)
                    if should_restart:
                        from quantahut import restart_app
                        from client_utils import get_last_fragment
                        fragment = get_last_fragment()
                        if fragment:
                            restart_app(fragment)
                        return

                from android_utils import run_on_ui_thread
                run_on_ui_thread(lambda: bottom_sheet.dismiss())
        
        action_button.setOnClickListener(ActionClickImpl())
        linear_layout.addView(action_button, LayoutHelper.createLinear(-1, 48, Gravity.START, 14, 20, 14, 14))
        
        current_selection = []
        for i, key in enumerate(setting_keys):
            is_selected = False
            
            setting_value = plugin_instance.get_setting(key)
            if setting_value is not None:
                is_selected = bool(setting_value)
            elif default and key in default:
                is_selected = True
                
            if is_selected:
                current_selection.append(i)
                selected_items.add(i)
                checkboxes[i].setChecked(True, False)
        
        update_action_button_text()
        
        bottom_sheet.show()
        
    except Exception as e:
        pass


class _MessageMenuRegistry:
    def __init__(self):
        self.items = []
        self._unhook_fill = None
        self._unhook_process = None

    def ensure_hooks(self, plugin: BasePlugin):
        try:
            if not self._unhook_fill:
                fill_method = ChatActivity.getClass().getDeclaredMethod(
                    "fillMessageMenu",
                    MessageObject,
                    ArrayList,
                    ArrayList,
                    ArrayList
                )
                self._unhook_fill = plugin.hook_method(fill_method, _QHFillMenuHook(self))
        except Exception as e:
            quantahut_log(f"fillMessageMenu hook error: {str(e)}")
        try:
            if not self._unhook_process:
                process_method = ChatActivity.getClass().getDeclaredMethod(
                    "processSelectedOption",
                    Integer.TYPE
                )
                self._unhook_process = plugin.hook_method(process_method, _QHProcessOptionHook(self))
        except Exception as e:
            quantahut_log(f"processSelectedOption hook error: {str(e)}")

    def register_item(self, *, text: str, option_id: int, icon_res: int, condition_predicate, on_click, insert_at_top: bool):
        handle = {
            'text': text,
            'option_id': int(option_id),
            'icon_res': int(icon_res),
            'condition': condition_predicate,
            'on_click': on_click,
            'insert_top': bool(insert_at_top),
        }
        self.items.append(handle)
        return handle

    def unregister_item(self, handle):
        try:
            if handle in self.items:
                self.items.remove(handle)
        except Exception:
            pass

    def cleanup_hooks(self, plugin: BasePlugin):
        try:
            if self._unhook_fill:
                plugin.unhook_method(self._unhook_fill)
                self._unhook_fill = None
                quantahut_log("fillMessageMenu hook removed")
        except Exception:
            pass
        
        try:
            if self._unhook_process:
                plugin.unhook_method(self._unhook_process)
                self._unhook_process = None
                quantahut_log("processSelectedOption hook removed")
        except Exception:
            pass
        
        self.items.clear()
        quantahut_log("QuantaHut hooks cleaned up")


class _QHFillMenuHook:
    def __init__(self, registry: _MessageMenuRegistry):
        self.registry = registry

    def before_hooked_method(self, param):
        pass

    def after_hooked_method(self, param):
        try:
            primary = param.args[0]
            if primary is None:
                return
            try:
                self.registry.last_message = primary
            except Exception:
                pass
            icons = param.args[1]
            items = param.args[2]
            options = param.args[3]

            for entry in list(self.registry.items):
                try:
                    if entry.get('condition') and callable(entry['condition']):
                        if not entry['condition'](primary):
                            continue
                    if entry.get('insert_top'):
                        icons.add(0, Integer(entry['icon_res']))
                        options.add(0, Integer(entry['option_id']))
                        items.add(0, entry['text'])
                    else:
                        details_index = -1
                        try:
                            from org.telegram.messenger import LocaleController, R as R_extera
                            details_string = LocaleController.getString(R_extera.string.Details)
                            for i in range(items.size()):
                                if str(items.get(i)) == details_string:
                                    details_index = i
                                    break
                        except Exception:
                            pass
                        
                        if details_index >= 0:
                            icons.add(details_index, Integer(entry['icon_res']))
                            options.add(details_index, Integer(entry['option_id']))
                            items.add(details_index, entry['text'])
                        else:
                            icons.add(Integer(entry['icon_res']))
                            options.add(Integer(entry['option_id']))
                            items.add(entry['text'])
                except Exception:
                    continue
        except Exception:
            pass


class _QHProcessOptionHook:
    def __init__(self, registry: _MessageMenuRegistry):
        self.registry = registry

    def before_hooked_method(self, param):
        try:
            option = param.args[0]
            try:
                opt_val = int(option)
            except Exception:
                try:
                    opt_val = option.intValue()
                except Exception:
                    return

            for entry in list(self.registry.items):
                if opt_val == entry.get('option_id'):
                    try:
                        chat_activity = param.thisObject
                        message = getattr(chat_activity, 'selectedObject', None)
                        if message is None:
                            message = getattr(self.registry, 'last_message', None)
                        try:
                            chat_activity.closeMenu()
                        except Exception:
                            pass
                        if callable(entry.get('on_click')):
                            entry['on_click'](chat_activity, message)
                        param.setResult(None)
                    except Exception:
                        pass
                    finally:
                        return
        except Exception:
            pass

    def after_hooked_method(self, param):
        pass


_message_menu_registry = _MessageMenuRegistry()


def _ensure_message_menu_hooks(plugin: BasePlugin):
    _message_menu_registry.ensure_hooks(plugin)

def cleanup_quantahut_hooks(plugin: BasePlugin):
    _message_menu_registry.cleanup_hooks(plugin)


class HutUtilities:
    def register_message_menu_item(self, *, text: str, option_id: int, icon_res: int = R_tg.drawable.msg_message_s, condition_predicate=None, on_click=None, insert_at_top: bool = False):
        try:
            return _message_menu_registry.register_item(
                text=text,
                option_id=option_id,
                icon_res=icon_res,
                condition_predicate=condition_predicate,
                on_click=on_click,
                insert_at_top=insert_at_top,
            )
        except Exception as e:
            quantahut_log(f"utilities.register_message_menu_item error: {str(e)}")
            return None

    def unregister_message_menu_item(self, handle):
        try:
            if handle:
                _message_menu_registry.unregister_item(handle)
        except Exception as e:
            quantahut_log(f"utilities.unregister_message_menu_item error: {str(e)}")


utilities = HutUtilities()
hut = utilities

available_languages = []


def showupdatebottomsheet(title, subtitle=None, description=None, github_url=None, plugin_name=None, sticker_pack=None, sticker_index=None, raw_resource=None, button_text="Download", button2_text=None, bottom_text=None, show_close_button=True, show_user_avatar=False, sticker_circle=True, sticker_size=90, description_centered=False, on_button_click=None, on_button2_click=None, on_sticker_long_click=None):
    try:
        from android_utils import run_on_ui_thread
        
        def create_and_show():
            try:
                current_fragment = get_last_fragment()
                if not current_fragment:
                    quantahut_log("Cannot show bottom sheet, no current fragment.")
                    return
                
                activity = current_fragment.getParentActivity()
                if not activity:
                    quantahut_log("Cannot show bottom sheet, no activity.")
                    return
                
                bottom_sheet = UpdateBottomSheet(activity, activity, current_fragment, github_localization.localization_cache)
                bottom_sheet.create_bottom_sheet(title, subtitle, description, github_url, plugin_name, sticker_pack, sticker_index, raw_resource, button_text, button2_text, bottom_text, show_close_button, show_user_avatar, sticker_circle, sticker_size, description_centered, on_button_click, on_button2_click, on_sticker_long_click)
                bottom_sheet.show()
                
            except Exception as e:
                quantahut_log(f"Error showing bottom sheet: {str(e)}")
        
        run_on_ui_thread(create_and_show)
        
    except Exception as e:
        quantahut_log(f"Error in showupdatebottomsheet: {str(e)}")



def quantahut_log(string: str):
    if setting_getter and setting_getter("show_logs", DEFAULT_SHOW_LOGS):
        log(f"[QuantaHut] {string}")

def get_string(key: str, default: str = None) -> str:
    try:
        return get_localized_string("UiTweaks", key, default or key)
    except Exception as e:
        quantahut_log(f"Error getting localized text: {e}")
        return default or key

__all__ = [
    'UpdateBottomSheet',
    'showmultiselector', 
    'showupdatebottomsheet',
    'utilities',
    'available_languages',
    'get_string',
    'quantahut_log',
    'QuantaHutPlugin',
    'cleanup_quantahut_hooks'
]


class _SearchPollingRunnable(RunnableProxy):
    def __init__(self, plugin, activity, search_item, handler):
        super().__init__()
        self.plugin = plugin
        self.activity = activity
        self.search_item = search_item
        self.handler = handler
        self.aid = id(activity)
        self.last_query = ""
        self.was_active = False

    def run(self):
        try:
            state = self.plugin.get_search_state(self.aid)
            
            if self.search_item.isSearchFieldVisible():
                if not state["reset_hidden"]:
                    reset_item = get_private_field(self.activity, "resetItem")
                    if reset_item:
                        reset_item.setVisibility(8)
                        state["reset_hidden"] = True

                state["active"] = True
                search_field = self.search_item.getSearchField()
                if search_field:
                    query = str(search_field.getText().toString())
                    
                    show_history = (query == "")
                    if show_history != state.get("show_history", False):
                        state["show_history"] = show_history
                        list_view = get_private_field(self.activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)
                    
                    if query != self.last_query:
                        if self.last_query and len(self.last_query) >= 2 and query == "":
                            plugin = get_private_field(self.activity, "plugin")
                            if plugin:
                                self.plugin.add_to_history(plugin.getId(), self.last_query)
                        
                        self.last_query = query
                        state["query"] = query
                        list_view = get_private_field(self.activity, "listView")
                        if list_view and list_view.adapter:
                            list_view.adapter.update(True)

                self.was_active = True
                self.handler.postDelayed(self, 200)
            else:
                if state["reset_hidden"]:
                    reset_item = get_private_field(self.activity, "resetItem")
                    if reset_item:
                        PC = jclass("com.exteragram.messenger.plugins.PluginsController")
                        plugin = get_private_field(self.activity, "plugin")
                        if plugin and PC.getInstance().hasPluginSettingsPreferences(plugin.getId()):
                            reset_item.setVisibility(0)
                    state["reset_hidden"] = False

                if state["active"]:
                    if self.last_query and len(self.last_query) >= 2:
                        plugin = get_private_field(self.activity, "plugin")
                        if plugin:
                            self.plugin.add_to_history(plugin.getId(), self.last_query)
                    
                    state["active"] = False
                    state["query"] = ""
                    state["show_history"] = False
                    self.last_query = ""
                    list_view = get_private_field(self.activity, "listView")
                    if list_view and list_view.adapter:
                        list_view.adapter.update(True)

                self.was_active = False
                self.handler.postDelayed(self, 500)

        except Exception as e:
            pass


class _PluginSettingsSearchCreateViewHook:
    def __init__(self, plugin):
        self.plugin = plugin

    def after_hooked_method(self, param):
        try:
            activity = param.thisObject
            aid = id(activity)

            action_bar = get_private_field(activity, "actionBar")
            if not action_bar:
                return

            menu = action_bar.menu if action_bar.menu else action_bar.createMenu()
            if not menu:
                return

            R = jclass("org.telegram.messenger.R")
            LocaleController = jclass("org.telegram.messenger.LocaleController")
            R_string = jclass("org.telegram.messenger.R$string")

            search_item = menu.addItem(0, R.drawable.ic_ab_search)
            search_item.setIsSearchField(True)
            search_item.setSearchFieldHint(LocaleController.getString(R_string.Search))
            set_private_field(activity, "searchItem", search_item)

            self.plugin._activity_refs[aid] = {"activity": activity, "search_item": search_item}

            from android.os import Handler, Looper
            handler = Handler(Looper.getMainLooper())
            runnable = _SearchPollingRunnable(self.plugin, activity, search_item, handler)
            handler.post(runnable)

        except Exception as e:
            pass


class _PluginSettingsSearchFillItemsHook:
    def __init__(self, plugin):
        self.plugin = plugin

    def after_hooked_method(self, param):
        try:
            activity = param.thisObject
            aid = id(activity)
            items = param.args[0]

            if not items:
                return

            state = self.plugin.get_search_state(aid)
            if not state["active"]:
                return

            sub_callback = get_private_field(activity, "createSubFragmentCallback")
            if sub_callback is not None:
                query = state["query"].strip().lower()
                if query:
                    to_remove = []
                    for i in range(items.size()):
                        item = items.get(i)
                        if item is None:
                            continue
                        if not self.plugin._matches_query(item, query):
                            to_remove.append(i)
                    for i in reversed(to_remove):
                        items.remove(i)
                return

            plugin = get_private_field(activity, "plugin")
            if not plugin:
                return

            pid = plugin.getId()

            query = state["query"].strip().lower()
            
            if not query and state.get("show_history", False):
                history = self.plugin.get_search_history(pid)
                if history:
                    items.clear()
                    
                    UItem = jclass("org.telegram.ui.Components.UItem")
                    TextSetting = jclass("com.exteragram.messenger.plugins.models.TextSetting")
                    items.add(UItem.asHeader(get_string("recent_searches", "Recent searches")))
                    
                    for qt in history:
                        def make_cb(q, a):
                            def cb(*args):
                                try:
                                    if a in self.plugin._activity_refs:
                                        si = self.plugin._activity_refs[a].get("search_item")
                                        if si:
                                            sf = si.getSearchField()
                                            if sf:
                                                sf.setText(q)
                                                sf.setSelection(len(q))
                                except: pass
                            return cb
                        
                        callback = make_cb(qt, aid)
                        setting = TextSetting(qt, None, False, False, callback, None, None, None)
                        
                        h_item = UItem.asButton(0, qt)
                        h_item.settingItem = setting
                        items.add(h_item)
                return
            
            if not query:
                return
            
            if pid not in self.plugin._all_items_cache:
                self.plugin._all_items_cache[pid] = self.plugin._collect_all_items(activity, plugin, items)

            all_items = self.plugin._all_items_cache[pid]

            items.clear()

            for item in all_items:
                if self.plugin._matches_query(item, query):
                    items.add(item)

        except Exception as e:
            pass
